<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•/æˆç¸¾èªè­‰æŸ¥è©¢ç³»çµ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- ç¾å­¸èˆ‡è®Šæ•¸å®šç¾© --- */
        :root {
            /* æ ¸å¿ƒè‰²ç³» */
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --primary-light: #eff6ff;
            
            --success: #10b981;
            --success-hover: #059669;
            --success-light: #ecfdf5;

            --danger: #ef4444;
            --danger-hover: #dc2626;
            --danger-light: #fef2f2;

            --warning: #f59e0b;
            --warning-hover: #d97706;
            
            --info: #6366f1;
            --info-hover: #4f46e5;

            /* ä¸­æ€§è‰² */
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            
            /* é–“è·èˆ‡åœ“è§’ */
            --radius-sm: 6px;  /* æŒ‰æŒ‰æŒ‰æŒ‰éˆ•/è¼¸å…¥æ¡† */
            --radius-md: 12px; /* å¡ç‰‡ */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Noto Sans TC', sans-serif; }
        
        /* Body æ’ç‰ˆ */
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            line-height: 1.6; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 0;
        }
        
        /* å®¹å™¨ */
        #app-container { 
            max-width: 1440px; 
            width: 100%; 
            padding: 20px; 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
        }

        /* æ¨™é¡Œ */
        h1 { text-align: center; color: var(--text-main); margin-bottom: 30px; font-weight: 700; letter-spacing: -0.5px; }
        h2 { font-size: 1.4em; font-weight: 600; margin-bottom: 15px; color: var(--text-main); }
        h3 { font-size: 1.1em; font-weight: 600; margin-bottom: 12px; color: var(--text-main); }

        /* å¡ç‰‡é€šç”¨æ¨£å¼ */
        .card { 
            background-color: var(--bg-card); border-radius: var(--radius-md); 
            box-shadow: var(--shadow-sm); padding: 30px; margin-bottom: 0; 
            border: 1px solid transparent; transition: box-shadow 0.3s ease;
        }
        .card:hover { box-shadow: var(--shadow-md); }

        /* è¡¨å–®å…ƒç´  */
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9em; color: var(--text-secondary); }
        .input-group textarea, .input-group input, .input-group select {
            width: 100%; padding: 10px 14px; 
            border: 1px solid var(--border); border-radius: var(--radius-sm); 
            font-size: 1em; background: #fff; color: var(--text-main);
            transition: all 0.2s;
        }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus { 
            border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px var(--primary-light); 
        }
        
        /* æŒ‰éˆ•ç³»çµ± */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 8px 16px; border: none; border-radius: var(--radius-sm); 
            font-size: 0.9em; font-weight: 500; cursor: pointer; 
            transition: all 0.2s ease; text-decoration: none; line-height: 1.5;
        }
        .btn:active { transform: scale(0.98); }
        
        /* é¡è‰²è®Šé«” */
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        
        .btn-secondary { background-color: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-secondary:hover { background-color: var(--bg-body); border-color: #cbd5e1; }
        
        .btn-success { background-color: var(--success); color: white; }
        .btn-success:hover { background-color: var(--success-hover); }
        
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover { background-color: var(--danger-hover); }

        /* å°å°ºå¯¸æŒ‰éˆ• */
        .btn-small { padding: 5px 10px; font-size: 0.85em; border-radius: 4px; }

        /* æŒ‰éˆ•ç¾¤çµ„èˆ‡é–“è· */
        .button-group, .action-btn-group { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        
        /* éš±è—é¡ */
        .hidden { display: none !important; }

        /* ç®¡ç†ä»‹é¢æ¨™ç±¤é  */
        .admin-tabs { display: flex; background: var(--bg-body); padding: 4px; border-radius: var(--radius-sm); width: fit-content; }
        .tab-btn {
            padding: 8px 20px; cursor: pointer; border: none; background: transparent; 
            font-size: 0.9em; font-weight: 600; color: var(--text-secondary); border-radius: 4px;
            transition: all 0.3s;
        }
        .tab-btn:hover { color: var(--text-main); }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: var(--shadow-sm); font-weight: 600; }

        /* è¡¨æ ¼å„ªåŒ– */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; overflow: hidden; border-radius: var(--radius-sm); }
        .data-table th { 
            background-color: #f8fafc; color: var(--text-secondary); font-weight: 600; font-size: 0.9em; 
            text-align: left; padding: 12px 16px; border-bottom: 1px solid var(--border); 
        }
        .data-table td { 
            padding: 12px 16px; border-bottom: 1px solid var(--border); 
            color: var(--text-main); font-size: 0.95em; 
        }
        .data-table tbody tr:last-child td { border-bottom: none; }
        .data-table tbody tr:hover { background-color: #fcfcfc; }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .badge { display: inline-block; padding: 2px 8px; border-radius: 9999px; font-size: 0.8em; font-weight: 600; }
        .status-å·²èªè­‰ { background-color: var(--success-light); color: var(--success); }
        .status-å¯©æ ¸ä¸­, .status-èªè­‰ä¸­ { background-color: var(--primary-light); color: var(--primary); }
        .status-èªè­‰å¤±æ•— { background-color: var(--danger-light); color: var(--danger); }
        .status-æœªå®Œæˆ { background-color: #f1f5f9; color: var(--text-secondary); }
        .team-badge { background-color: var(--info); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; margin-right: 8px; }
        .type-badge-group { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; margin-right: 4px; }
        .type-personal { background-color: #e0e7ff; color: #4338ca; }
        .type-team { background-color: #dbeafe; color: #1e40af; }

        /* ç®¡ç†ä»‹é¢ä½ˆå±€ */
        .admin-layout { display: grid; grid-template-columns: 480px 1fr; gap: 24px; align-items: start; }
        @media (max-width: 1024px) { .admin-layout { grid-template-columns: 1fr; } }

        .sidebar { background: white; padding: 24px; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); min-height: 400px; border: 1px solid var(--border); }
        .list-container { background: white; padding: 24px; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); min-height: 500px; border: 1px solid var(--border); }

        .list-search { 
            width: 100%; margin-bottom: 10px; padding: 8px 12px; 
            border: 1px solid var(--border); border-radius: var(--radius-sm); 
            background-color: #f8fafc; color: var(--text-main);
            font-size: 0.9em;
        }
        .list-search::placeholder { color: #94a3b8; }

        .stat-box { background: var(--primary-light); padding: 15px; border-radius: var(--radius-sm); margin-bottom: 10px; text-align: center; border: 1px solid #dbeafe; }
        .stat-num { font-size: 1.8em; font-weight: 700; color: var(--primary); display: block; }
        .stat-label { font-size: 0.85em; color: var(--text-main); }

        /* Modal */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fff; padding: 30px; border-radius: var(--radius-md); width: 90%; max-width: 550px;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); position: relative;
            animation: modalFadeIn 0.2s ease-out; max-height: 90vh; display: flex; flex-direction: column;
        }
        .modal-body { overflow-y: auto; margin: 20px 0; padding: 0; background: transparent; border: none; flex-grow: 1; }
        .modal-scroll { overflow-y: auto; padding-right: 5px; }
        .close-modal { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; color: #94a3b8; transition: 0.2s; }
        .close-modal:hover { color: var(--text-main); }

        .comment { padding: 14px; border-radius: var(--radius-sm); font-size: 0.95em; margin-bottom: 10px; animation: fadeIn 0.3s; line-height: 1.5; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .comment-student { background-color: white; border: 1px solid var(--border); align-self: flex-start; max-width: 85%; margin-right: auto; }
        .comment-teacher { background-color: var(--primary-light); border: 1px solid var(--primary); color: var(--primary-dark); align-self: flex-end; max-width: 85%; text-align: left; margin-left: auto; }
        .comment-recalled { background: repeating-linear-gradient(45deg, #f1f5f9, #f1f5f9 10px, #fff 10px, #fff 20px); border: 1px dashed #cbd5e1; text-align: center; font-style: italic; color: #94a3b8; width: 100%; max-width: 100%; align-self: center; }

        .task-admin-container { margin-bottom:10px; max-height: 250px; overflow-y:auto; border:1px solid var(--border); border-radius:var(--radius-sm); }

        .admin-table-inner { width:100%; border-collapse: collapse; font-size: 0.9em; }
        .admin-table-inner thead { background:#f8fafc; position:sticky; top:0; z-index:10; }
        .admin-table-inner th { padding:8px 6px; font-weight:600; font-size:0.8em; color:var(--text-secondary); border-bottom:1px solid var(--border); white-space: nowrap;}
        .admin-table-inner td { padding:8px 6px; border-bottom:1px solid var(--border); vertical-align: middle; }

        .preview-box { background: #1e293b; color: #a5b4fc; padding: 15px; border-radius: var(--radius-sm); font-family: monospace; font-size: 0.9em; white-space: pre-wrap; margin-top: 10px; border: 1px solid #334155; }
        .rule-help { background:#eff6ff; padding:15px; font-size:0.85em; border:1px solid #dbeafe; border-radius:var(--radius-sm); margin-bottom:15px; color:#475569;}
        .rule-help code { background:#e0e7ff; padding:2px 6px; border-radius:4px; color:#4338ca; font-family: monospace; }

        .team-list-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid var(--border); transition: background 0.2s; }
        .team-list-item:last-child { border-bottom: none; }
        .team-list-item:hover { background-color: #f8fafc; }

        .batch-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .batch-table th { background: #f8fafc; color: var(--text-secondary); font-weight: 600; padding: 10px; text-align: left; border-bottom: 2px solid var(--border); }
        .batch-table td { padding: 8px; border-bottom: 1px solid var(--border); cursor: text; }
        .batch-table input { width: 100%; border: 1px solid transparent; background: transparent; padding: 6px; font-size: inherit; border-radius: 4px; transition: 0.2s; cursor: text; }
        .batch-table input:hover { border-color: #cbd5e1; background: #fff; }
        .batch-table input:focus { border-color: var(--primary); background: white; outline: none; cursor: text;}
        
        /* Toast é€šçŸ¥ */
        #toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { 
            padding: 12px 20px; background: white; border-radius: var(--radius-sm); 
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); 
            animation: slideIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); 
            min-width: 280px; display: flex; align-items: center; font-weight: 500;
            border-left: 4px solid var(--primary);
        }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.warning { border-left-color: var(--warning); }
        
        /* è¼‰å…¥å‹•ç•«èˆ‡é®ç½© */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); z-index: 20000;
            display: none; align-items: center; justify-content: center; flex-direction: column;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* å‹•ç•« */
        @keyframes slideIn { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Confirm Dialog */
        #confirm-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10001; display: none; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .confirm-box { background: #fff; padding: 32px; border-radius: var(--radius-md); text-align: center; min-width: 320px; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
    </style>
</head>
<body>

    <!-- è¼‰å…¥ä¸­é®ç½© -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top:15px; color:var(--text-secondary); font-weight:600;">åŒæ­¥è³‡æ–™åº«ä¸­ï¼Œè«‹ç¨å€™...</p>
    </div>

    <div id="app-container">
        <h1>æ´»å‹•/æˆç¸¾èªè­‰æŸ¥è©¢ç³»çµ±</h1>

        <!-- Toast é€šçŸ¥å€ -->
        <div id="toast-container"></div>
        <!-- ç¢ºèªå°è©±æ¡†å€ -->
        <div id="confirm-container"></div>

        <!-- 1. å­¸ç”Ÿç™»å…¥ -->
        <div id="login-container" class="card" style="max-width: 480px; margin: 40px auto; padding: 40px;">
            <h2 style="text-align:center; margin-bottom:30px;">æˆç¸¾æŸ¥è©¢ç™»å…¥</h2>
            <form id="login-form">
                <div class="input-group">
                    <label>å­¸æ ¡åç¨±</label>
                    <input type="text" id="school" value="æ°¸é–é«˜å·¥" required>
                </div>
                <div class="input-group">
                    <label>ç­ç´š</label>
                    <input type="text" id="class" value="è³‡è¨ŠäºŒ" required>
                </div>
                <div class="input-group">
                    <label>å­¸è™Ÿ</label>
                    <input type="text" id="account" placeholder="è«‹è¼¸å…¥å­¸è™Ÿ" required>
                </div>
                <div class="input-group">
                    <label>å¯†ç¢¼ (ç™»å…¥ç”¨ï¼Œç„¡æ³•ä¿®æ”¹)</label>
                    <input type="password" id="password" placeholder="è¼¸å…¥æŸ¥è©¢å¯†ç¢¼" required>
                </div>
                <div class="button-group wide" style="margin-top:30px; flex-direction:column;">
                    <button type="submit" class="btn btn-primary" style="width:100%; padding:12px 0;">ç™»å…¥æŸ¥è©¢</button>
                    <button type="button" class="btn btn-secondary" style="width:100%;" onclick="window.showAdminLogin()">æˆ‘æ˜¯æ•™å¸«</button>
                </div>
                <div id="login-error" class="hidden" style="color: var(--danger); margin-top: 20px; font-weight: 600; text-align: center; padding: 10px; background: var(--danger-light); border-radius: var(--radius-sm);"></div>
            </form>
        </div>

        <!-- 2. æ•™å¸«ç™»å…¥ -->
        <div id="admin-login-container" class="card hidden" style="max-width: 400px; margin: 40px auto; padding: 40px;">
            <h2 style="text-align:center; margin-bottom:30px;">æ•™å¸«ç®¡ç†å“¡ç™»å…¥</h2>
            <form id="admin-login-form">
                <div class="input-group">
                    <label>ç®¡ç†å¯†ç¢¼</label>
                    <input type="password" id="admin-password" required>
                </div>
                <div class="button-group wide" style="margin-top:30px; flex-direction:column;">
                    <button type="submit" class="btn btn-primary" style="width:100%; padding:12px 0;">ç™»å…¥ç®¡ç†</button>
                    <button type="button" class="btn btn-secondary" style="width:100%;" onclick="window.showStudentLogin()">è¿”å›</button>
                </div>
                <div id="admin-login-error" class="hidden" style="color: var(--danger); margin-top: 20px; font-weight: 600; text-align: center; padding: 10px; background: var(--danger-light); border-radius: var(--radius-sm);"></div>
            </form>
        </div>

        <!-- 3. å­¸ç”Ÿçµæœé é¢ -->
        <div id="result-container" class="hidden">
            <div class="card" style="max-width: 800px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; padding-bottom:20px; border-bottom:1px solid var(--border);">
                    <h3>å­¸ç”ŸåŸºæœ¬è³‡æ–™</h3>
                    <button class="btn btn-secondary" onclick="window.logout()">ç™»å‡º</button>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <p><label style="color:var(--text-secondary); font-size:0.9em;">å­¸è™Ÿï¼š</label><span id="result-account"></span></p>
                    <p><label style="color:var(--text-secondary); font-size:0.9em;">å§“åï¼š</label><span id="result-name"></span></p>
                    <p><label style="color:var(--text-secondary); font-size:0.9em;">å­¸æ ¡ï¼š</label><span id="result-school"></span></p>
                    <p><label style="color:var(--text-secondary); font-size:0.9em;">ç­ç´šï¼š</label><span id="result-class"></span></p>
                    <p><label style="color:var(--text-secondary); font-size:0.9em;">é›»å­éƒµä»¶ï¼š</label><span id="result-email"></span></p>
                </div>
            </div>
            
            <div class="card" style="max-width: 1000px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; padding-bottom:15px; border-bottom:1px solid var(--border);">
                    <h2>å­¸æœŸæˆç¸¾é …ç›®</h2>
                    <button class="btn btn-info" onclick="window.openTeamJoinModal()">æŸ¥çœ‹/åŠ å…¥åœ˜éšŠæ´»å‹•</button>
                </div>
                <table id="tasks-table-student" class="data-table">
                    <thead><tr><th>é …ç›®åç¨± (é¡å‹)</th><th>ç‹€æ…‹</th><th style="text-align:right;">æ“ä½œ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- 4. æ•™å¸«ç®¡ç†ä»‹é¢ -->
        <div id="admin-container" class="hidden">
            <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; flex-wrap:wrap; gap:15px;">
                <div class="admin-tabs">
                    <button class="tab-btn active" onclick="window.switchAdminTab('student')">å­¸ç”Ÿè³‡æ–™ç®¡ç†</button>
                    <button class="tab-btn" onclick="window.switchAdminTab('team')">åœ˜éšŠæ´»å‹•</button>
                    <button class="tab-btn" onclick="window.switchAdminTab('overview')">èªè­‰ç¸½è¦½</button>
                    <button class="tab-btn" onclick="window.switchAdminTab('batch')">æ‰¹é‡æ–°å¢</button>
                </div>
                <div class="action-btn-group">
                    <button class="btn btn-secondary btn-small" onclick="window.adminLogout()">ç™»å‡ºæ•™å¸«</button>
                    <button class="btn btn-success btn-small" onclick="window.exportData()">åŒ¯å‡ºæœ¬åœ°å‚™ä»½</button>
                </div>
            </header>
            
            <div class="admin-layout">
                <!-- å·¦å´é‚Šæ¬„ -->
                <div class="sidebar">
                    
                    <!-- é¸é …å¡ 1: å­¸ç”Ÿç®¡ç†é¢æ¿ -->
                    <div id="tab-student-action">
                        <div id="admin-welcome-panel">
                            <h3>ç®¡ç†é¸å–®</h3>
                            <div style="display:flex; flex-direction:column; gap:12px; margin-top:16px;">
                                <button class="btn btn-warning" style="width:100%; justify-content: flex-start;" onclick="window.showStudentForm('new')">â• æ–°å¢å–®ä¸€å­¸ç”Ÿ</button>
                                <button class="btn btn-info" style="width:100%; justify-content: flex-start;" onclick="window.openTeamModal(false)">â• æ–°å¢åœ˜éšŠæ´»å‹•</button>
                            </div>
                            <div style="margin-top:30px; padding:20px; background:#f8fafc; border-radius:var(--radius-sm); border:1px solid var(--border);">
                                <h4 style="margin-bottom:10px; font-size:0.9em; color:var(--text-secondary);">Google Sheet é€£ç·šç‹€æ…‹</h4>
                                <div id="sync-status" style="font-size:0.85em; color:var(--success); font-weight:600;">æª¢æŸ¥ä¸­...</div>
                            </div>
                        </div>

                        <div id="student-form-panel" class="hidden">
                            <h3>ç·¨è¼¯/æ–°å¢å­¸ç”Ÿ</h3>
                            <form id="student-form" style="margin-top:20px;">
                                <div class="input-group">
                                    <label>å­¸è™Ÿ</label>
                                    <input type="text" id="admin-account" required>
                                </div>
                                <div class="input-group">
                                    <label>å§“å</label>
                                    <input type="text" id="admin-name" required>
                                </div>
                                <div class="input-group">
                                    <label>å­¸æ ¡</label>
                                    <input type="text" id="admin-school" value="æ°¸é–é«˜å·¥" required>
                                </div>
                                <div class="input-group">
                                    <label>ç­ç´š</label>
                                    <input type="text" id="admin-class" value="è³‡è¨ŠäºŒ" required>
                                </div>
                                <div class="input-group">
                                    <label>Email</label>
                                    <input type="email" id="admin-email">
                                </div>
                                
                                <h4 style="margin:20px 0 10px 0; color:var(--text-main); font-size:0.95em;">å€‹äººé …ç›®åˆ—è¡¨</h4>
                                <div class="task-admin-container">
                                    <table id="tasks-table-admin" class="admin-table-inner">
                                        <thead>
                                            <tr><th style="text-align:left; width: 40%;">åç¨±</th><th style="text-align:left; width: 25%;">ç‹€æ…‹</th><th style="text-align:center; width: 25%;">ç•™è¨€</th><th style="text-align:center; width: 10%;"></th></tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                                <button type="button" class="btn btn-secondary btn-small" style="margin-top:5px;" onclick="window.addTaskRow()">+ æ–°å¢å€‹äººé …ç›®</button>
                                
                                <div class="action-btn-group" style="margin-top:24px; border-top:1px solid var(--border); padding-top:16px;">
                                    <button type="submit" id="submit-student-btn" class="btn btn-primary">å„²å­˜è®Šæ›´</button>
                                    <button type="button" id="switch-to-new-student-btn" class="btn btn-success hidden" onclick="window.switchToNewStudentMode(true)">åˆ‡æ›è‡³æ–°å¢</button>
                                    <button type="button" class="btn btn-secondary" onclick="window.showWelcomePanel()">å–æ¶ˆ</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- é¸é …å¡ 2: åœ˜éšŠæ“ä½œé¢æ¿ -->
                    <div id="tab-team-action" class="hidden">
                        <h3>åœ˜éšŠæ´»å‹•æ“ä½œ</h3>
                        <button class="btn btn-success" style="width:100%; margin-bottom:20px;" onclick="window.openTeamModal(false)">å»ºç«‹æ–°åœ˜éšŠæ´»å‹•</button>
                        
                        <div style="background:var(--primary-light); padding:20px; border-radius:var(--radius-sm); border:1px solid #dbeafe; color:var(--primary);">
                            <h4 style="margin-bottom:10px; font-size:0.95em;">åŠŸèƒ½èªªæ˜</h4>
                            <ul style="padding-left:20px; line-height: ChromeVoxOnSpeak; font-size:0.9em;">
                                <li>åœ˜éšŠæ´»å‹•å…è¨±å¤šä½å­¸ç”Ÿå…±åŒåƒèˆ‡åŒä¸€å€‹ä»»å‹™ã€‚</li>
                                <li>é–‹æ”¾åŠ å…¥ï¼šå­¸ç”Ÿå¯åœ¨é¦–é è‡ªè¡Œé»æ“ŠåŠ å…¥ã€‚</li>
                                <li>é™åˆ¶åŠ å…¥ï¼šåƒ…èƒ½ç”±æ•™å¸«åœ¨æ­¤æ‰‹å‹•è¼¸å…¥å­¸è™Ÿæ–°å¢æˆå“¡ã€‚</li>
                            </ul>
                        </div>
                    </div>

                    <!-- é¸é …å¡ 3: èªè­‰ç¸½è¦½é¢æ¿ -->
                    <div id="tab-overview-action" class="hidden">
                        <h3>èªè­‰çµ±è¨ˆèˆ‡éæ¿¾</h3>
                        <div style="margin-top:20px;">
                            <div class="stat-box">
                                <span class="stat-num" id="filtered-count">0</span>
                                <span class="stat-label">ç¬¦åˆç¯©é¸æ¢ä»¶é …ç›®</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div class="stat-box" style="background:var(--success-light); border-color: #d1fae5;">
                                    <span class="stat-num" style="color:var(--success);" id="filtered-certified">0</span>
                                    <span class="stat-label">å·²èªè­‰</span>
                                </div>
                                <div class="stat-box" style="background:var(--danger-light); border-color: #fee2e2;">
                                    <span class="stat-num" style="color:var(--danger);" id="filtered-failed">0</span>
                                    <span class="stat-label">å¾…è™•ç†/å¤±æ•—</span>
                                </div>
                            </div>
                            
                            <div style="margin-top:20px; padding:15px; background:#f1f5f9; border-radius:var(--radius-sm); border:1px solid var(--border);">
                                <h4 style="font-size:0.9em; margin-bottom:10px; color:var(--text-main);">ç¯©é¸å™¨</h4>
                                
                                <div class="input-group">
                                    <label>é¡å‹</label>
                                    <select id="overview-type-filter" class="list-search" onchange="renderGlobalList()">
                                        <option value="all">å…¨éƒ¨ (å€‹äºº + åœ˜éšŠ)</option>
                                        <option value="personal">åƒ…é¡¯ç¤º å€‹äººé …ç›®</option>
                                        <option value="team">åƒ…é¡¯ç¤º åœ˜éšŠæ´»å‹•</option>
                                    </select>
                                </div>

                                <div class="input-group">
                                    <label>ç‹€æ…‹</label>
                                    <select id="overview-status-filter" class="list-search" onchange="renderGlobalList()">
                                        <option value="all">å…¨éƒ¨ç‹€æ…‹</option>
                                        <option value="todo">å¾…è™•ç† (æœªå®Œæˆ / å¤±æ•— / å¯©æ ¸ä¸­)</option>
                                        <option value="certified">å·²èªè­‰</option>
                                        <option value="failed">èªè­‰å¤±æ•—</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- é¸é …å¡ 4: æ‰¹é‡æ“ä½œé¢æ¿ -->
                    <div id="tab-batch-action" class="hidden">
                        <h3>å¿«é€Ÿæ‰¹æ¬¡æ–°å¢</h3>
                        <div style="background:#f1f5f9; padding:20px; border-radius:var(--radius-sm); border:1px solid #e2e8f0; color:var(--text-secondary); margin-bottom:20px; font-size:0.9em;">
                            æ­¤åŠŸèƒ½ä½¿ç”¨è¦å‰‡ç”Ÿæˆå™¨è‡ªå‹•ç”¢ç”Ÿå­¸è™Ÿèˆ‡å¸³è™Ÿï¼Œé©ç”¨æ–¼å¤§é‡å»ºç«‹ã€‚
                        </div>
                        <button class="btn btn-primary" style="width:100%;" onclick="window.openBatchModal()">é–‹å•Ÿè¨­å®šè¦–çª—</button>
                    </div>

                </div>

                <!-- å³å´åˆ—è¡¨å€ -->
                <div class="list-container">
                    <h3 id="list-title" style="margin-bottom:16px;">å­¸ç”Ÿåˆ—è¡¨</h3>
                    
                    <!-- èªè­‰ç¸½è¦½å°ˆç”¨æœå°‹/éæ¿¾ -->
                    <div id="overview-search-container" class="hidden">
                        <label style="font-size:0.85em; font-weight:600; color:var(--text-secondary); margin-bottom:4px; display:block;">é—œéµå­—æœå°‹ (åç¨± / å­¸ç”Ÿ)</label>
                        <input type="text" id="overview-text-search" class="list-search" placeholder="è¼¸å…¥é—œéµå­—é€²è¡Œæœå°‹..." oninput="renderGlobalList()">
                    </div>
                    
                    <!-- å­¸ç”Ÿ/åœ˜éšŠåˆ—è¡¨æœå°‹ -->
                    <input type="text" id="student-search" class="list-search" placeholder="ğŸ” æœå°‹å­¸è™Ÿæˆ–å§“å..." onkeyup="window.filterStudentList()">

                    <div style="overflow-y:auto; max-height:600px; border:1px solid var(--border); border-radius:var(--radius-sm);">
                        <table id="main-table-display" class="data-table" style="margin:0; border:none;"></table>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- ç•™è¨€ Modal -->
    <div id="comment-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="window.closeModal('comment-modal')">&times;</span>
            <h3 id="modal-title">ç•™è¨€æ¿</h3>
            <div id="comment-history" class="modal-body"></div>
            <div id="new-comment-area" style="margin-top: 15px; border-top: 1px solid var(--border); padding-top: 15px; background:#f8fafc; padding:15px; border-radius:var(--radius-sm);">
                <textarea id="comment-input" rows="3" style="width:100%; margin-bottom:10px; border:1px solid var(--border); border-radius:var(--radius-sm); padding:10px;" placeholder="è¼¸å…¥ç•™è¨€..."></textarea>
                <button id="submit-comment-btn" class="btn btn-primary" style="width:100%;">é€å‡ºç•™è¨€</button>
            </div>
        </div>
    </div>

    <!-- åœ˜éšŠç·¨è¼¯/æ–°å¢ Modal -->
    <div id="team-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="window.closeModal('team-modal')">&times;</span>
            <h3 id="team-modal-title">ç®¡ç†åœ˜éšŠæ´»å‹•</h3>
            <div class="modal-scroll">
                <form id="team-form">
                    <input type="hidden" id="team-edit-id">
                    <div class="input-group">
                        <label>æ´»å‹•åç¨±</label>
                        <input type="text" id="team-name" required>
                    </div>
                    <div class="input-group">
                        <label>åŠ å…¥æ¨¡å¼</label>
                        <select id="team-join-mode">
                            <option value="open">å…è¨±åŠ å…¥ (å­¸ç”Ÿå¯è‡ªè¡ŒåŠ å…¥)</option>
                            <option value="restricted">åƒ…é™è¢«å‹•åŠ å…¥ (åƒ…æ•™å“¡å¯æ‹‰äºº)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>ç›®å‰ç‹€æ…‹</label>
                        <select id="team-status">
                            <option value="æœªå®Œæˆ">æœªå®Œæˆ</option>
                            <option value="å¯©æ ¸ä¸­">å¯©æ ¸ä¸­</option>
                            <option value="èªè­‰å¤±æ•—">èªè­‰å¤±æ•—</option>
                            <option value="å·²èªè­‰">å·²èªè­‰</option>
                        </select>
                    </div>
                    
                    <div class="action-btn-group" style="margin-top:20px; border-top:1px solid var(--border); padding-top:20px;">
                        <button type="submit" class="btn btn-primary">å„²å­˜åœ˜éšŠè¨­å®š</button>
                        <button type="button" class="btn btn-danger hidden" id="delete-team-btn">åˆªé™¤æ­¤æ´»å‹•</button>
                    </div>
                </form>

                <hr style="margin:25px 0; border:0; border-top:1px dashed var(--border);">

                <h4>æˆå“¡ç®¡ç†</h4>
                <p style="font-size:0.9em; color:var(--text-secondary); margin-bottom:10px;">è¼¸å…¥å®Œæ•´å­¸è™Ÿä¸¦æŒ‰æ–°å¢æŒ‰éˆ•ã€‚</p>
                <div class="action-btn-group">
                    <input type="text" id="team-add-member-input" placeholder="è¼¸å…¥å­¸è™Ÿ" style="padding:8px;">
                    <button class="btn btn-info" onclick="window.addMemberToTeam()">æ–°å¢æˆå“¡</button>
                </div>
                <div id="team-members-list" style="margin-top:15px; max-height:250px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <!-- å­¸ç”ŸåŠ å…¥åœ˜éšŠ Modal -->
    <div id="team-join-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="window.closeModal('team-join-modal')">&times;</span>
            <h3>å¯åŠ å…¥çš„åœ˜éšŠæ´»å‹•</h3>
            <div class="modal-body">
                <div id="available-teams-list"></div>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡æ–°å¢ Modal (è¦å‰‡è¨­å®š) -->
    <div id="batch-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="window.closeModal('batch-modal')">&times;</span>
            <h3>æ‰¹æ¬¡æ–°å¢è¦å‰‡è¨­å®š</h3>
            <div class="modal-scroll">
                <div class="rule-help">
                    <strong>å¯ç”¨åƒæ•¸èªªæ˜ï¼š</strong><br>
                    <code>[number]</code> : é€£çºŒè™Ÿç¢¼ã€‚ä¾‹å¦‚ <code>[number]{num=2}</code> ç”¢ç”Ÿ 01, 02<br>
                    <code>[year]</code> : å¹´ä»½ã€‚<code>[year]{national=roc}</code> = æ°‘åœ‹å¹´<br>
                    <code>[date]</code> : æ—¥æœŸã€‚<code>[date]{yyyymmdd}</code> = 20260203<br>
                    <code>[time]</code> : æ™‚é–“ã€‚<code>[time]{format=hhmm}</code> = 1330<br>
                    <code>[rand]</code> : äº‚æ•¸ã€‚<code>[rand]{num=1}</code> = 0-9<br>
                    <code>$text$</code> : å›ºå®šæ–‡å­—å‰ç¶´
                </div>

                <div class="input-group">
                    <label>ç”Ÿæˆæ•¸é‡ (èµ·å§‹ ~ çµæŸ)</label>
                    <div class="action-btn-group">
                        <input type="number" id="batch-start" value="1" placeholder="èµ·å§‹" oninput="window.updatePreview()">
                        <input type="number" id="batch-end" value="10" placeholder="çµæŸ" oninput="window.updatePreview()">
                    </div>
                </div>

                <hr style="margin:20px 0; border:0; border-top:1px dashed var(--border);">

                <div class="input-group">
                    <label>å­¸æ ¡é è¨­</label>
                    <input type="text" id="batch-school" value="æ°¸é–é«˜å·¥">
                </div>
                <div class="input-group">
                    <label>ç­ç´šé è¨­</label>
                    <input type="text" id="batch-class" value="è³‡è¨ŠäºŒ">
                </div>
                
                <div class="input-group">
                    <label>å­¸è™Ÿç”Ÿæˆè¦å‰‡</label>
                    <textarea id="batch-rule-account" rows="2" placeholder="ä¾‹å¦‚: [time][date]{yyyymmdd}" oninput="window.updatePreview()">[time][date]{yyyymmdd}</textarea>
                </div>

                <div class="input-group">
                    <label>Email è¦å‰‡</label>
                    <textarea id="batch-rule-email" rows="2" placeholder="ä¾‹å¦‚: [student_num]@school.edu.tw" oninput="window.updatePreview()">[student_num]@stu.yjvs.chc.edu.tw</textarea>
                </div>

                <h4 style="margin:15px 0 5px 0; font-size:0.9em; color:var(--text-secondary);">å³æ™‚é è¦½ (å‰3ç­†)</h4>
                <div class="preview-box" id="batch-preview">ç­‰å¾…è¼¸å…¥...</div>

                <div class="action-btn-group" style="margin-top:20px;">
                    <button class="btn btn-primary" onclick="window.prepareBatchReview()">ä¸‹ä¸€æ­¥ï¼šé è¦½ä¸¦ç”Ÿæˆ</button>
                    <button class="btn btn-secondary" onclick="window.closeModal('batch-modal')">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡æ–°å¢ Modal (å¯©æ ¸èˆ‡ç·¨è¼¯) -->
    <div id="batch-review-modal" class="modal">
        <div class="modal-content" style="max-width:800px;">
            <span class="close-modal" onclick="window.closeModal('batch-review-modal')">&times;</span>
            <h3>ç¢ºèªæ–°å¢è³‡æ–™ (Step 2/2)</h3>
            <p style="color:var(--text-secondary); margin-bottom:15px;">è«‹ç¢ºèªè³‡æ–™ã€‚æ‚¨å¯ä»¥ç›´æ¥ä¿®æ”¹è¡¨æ ¼å…§å®¹ã€‚</p>
            
            <div class="action-btn-group" style="background:#f8fafc; padding:15px; border-radius:var(--radius-sm); margin-bottom:15px;">
                <div style="flex:1;"><label style="font-size:0.8em; color:var(--text-secondary); display:block; margin-bottom:4px;">å…¨æ ¡çµ±ä¸€å­¸æ ¡</label><input type="text" id="review-global-school" placeholder="è¼¸å…¥ä»¥æ›´æ–°å…¨éƒ¨..."></div>
                <div style="flex:1;"><label style="font-size:0.8em; color:var(--text-secondary); display:block; margin-bottom:4px;">å…¨ç­çµ±ä¸€ç­ç´š</label><input type="text" id="review-global-class" placeholder="è¼¸å…¥ä»¥æ›´æ–°å…¨éƒ¨..."></div>
            </div>

            <div style="border:1px solid var(--border); border-radius:var(--radius-sm); max-height:400px; overflow-y:auto;">
                <table class="batch-table">
                    <thead>
                        <tr>
                            <th style="width: 25%;">å­¸æ ¡</th><th style="width: 15%;">ç­ç´š</th><th style="width: 20%;">å­¸è™Ÿ</th><th style="width: 15%;">å§“å</th><th style="width: 25%;">Email</th>
                        </tr>
                    </thead>
                    <tbody id="review-table-body"></tbody>
                </table>
            </div>

            <div class="action-btn-group" style="margin-top:20px; justify-content: flex-end;">
                <button class="btn btn-danger" onclick="window.closeModal('batch-review-modal')">æ”¾æ£„</button>
                <button class="btn btn-success" onclick="window.finalizeBatchAdd()">ç¢ºèªç”Ÿæˆè³‡æ–™</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // --- è¨­å®šå€ ---
        // æ‚¨çš„ Google Apps Script Web App URL
        let GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzd45-RTFooFTDyzGzCnGd_G1ttTwg_RdclnEbwRdeTKbf0jcOV7Xv5KgU2UZXyEEA/exec";

        const TEACHER_PASSWORD = 'Teacher@admin';
        const TEAMS_KEY = 'certSystem_teams';
        const STUDENTS_KEY = 'certSystem_students';
        
        // è³‡æ–™çµæ§‹
        let students = {}; 
        let teams = {};
        let currentMode = 'student'; 
        let editingStudentId = null;
        let editingTeamId = null;
        let viewingAccountId = null; 
        let viewingTaskId = null;
        let viewingIsTeam = false; 
        let nextTaskId = 100; 
        let pendingBatchList = []; 
        let isSyncing = false;

        // --- Google Sheet åŒæ­¥é‚è¼¯ (ä¿®æ­£ CORS ç‰ˆæœ¬) ---

        async function fetchDataFromSheet() {
            if (!GOOGLE_SCRIPT_URL) {
                const localS = localStorage.getItem(STUDENTS_KEY);
                const localT = localStorage.getItem(TEAMS_KEY);
                if (localS && localT) {
                    students = JSON.parse(localS);
                    teams = JSON.parse(localT);
                    showToast('å·²è¼‰å…¥æœ¬åœ°é›¢ç·šè³‡æ–™ (æœªè¨­å®š Google Sheet)', 'info');
                } else {
                    students = {
                         'A123456789': { account: 'A123456789', name: 'æ—æ›¸æ©', school: 'æ°¸é–é«˜å·¥', class: 'è³‡è¨ŠäºŒ', email: 'A123456789@stu.yjvs.chc.edu.tw', joinedTeams: [], tasks: [] }
                    };
                    teams = {};
                    showToast('ç„¡è³‡æ–™åº«é€£ç·šï¼Œç³»çµ±ç‚ºé›¢ç·šæ¨¡å¼', 'warning');
                }
                return;
            }

            showLoading(true);
            try {
                const payload = { action: 'getData' };
                const body = new URLSearchParams();
                body.append('data', JSON.stringify(payload));

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: body
                });

                if (!response.ok) throw new Error('Network response was not ok');
                
                const text = await response.text();
                // è™•ç†å¯èƒ½å‡ºç¾çš„ Google JSON åŒ…è£æ ¼å¼æˆ–ç›´æ¥ JSON
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    // å¦‚æœ GAS è¿”å›çš„æ˜¯ç´”å­—ä¸²ï¼Œå¯èƒ½éœ€è¦ç‰¹æ®Šè™•ç†ï¼Œä½†é€šå¸¸ä¸Šè¿°æ ¼å¼å®‰å…¨
                    throw new Error('è§£æ JSON å¤±æ•—: ' + text.substring(0,100));
                }
                
                if (data.result === 'success') {
                    students = data.students || {};
                    teams = data.teams || {};
                    localStorage.setItem(STUDENTS_KEY, JSON.stringify(students));
                    localStorage.setItem(TEAMS_KEY, JSON.stringify(teams));
                    document.getElementById('sync-status').innerHTML = 'âœ” å·²é€£ç·šä¸¦åŒæ­¥';
                    document.getElementById('sync-status').style.color = 'var(--success)';
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Sheet Sync Error:', error);
                showToast('è³‡æ–™åº«åŒæ­¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å¿«å–è³‡æ–™', 'error');
                document.getElementById('sync-status').innerHTML = 'âŒ åŒæ­¥å¤±æ•— (é›¢ç·šæ¨¡å¼)';
                document.getElementById('sync-status').style.color = 'var(--danger)';
                
                const localS = localStorage.getItem(STUDENTS_KEY);
                const localT = localStorage.getItem(TEAMS_KEY);
                if (localS && localT) {
                    students = JSON.parse(localS);
                    teams = JSON.parse(localT);
                }
            } finally {
                showLoading(false);
            }
        }

        async function pushDataToSheet() {
            if (!GOOGLE_SCRIPT_URL) {
                localStorage.setItem(STUDENTS_KEY, JSON.stringify(students));
                localStorage.setItem(TEAMS_KEY, JSON.stringify(teams));
                return; 
            }

            if (isSyncing) return; 
            isSyncing = true;
            
            localStorage.setItem(STUDENTS_KEY, JSON.stringify(students));
            localStorage.setItem(TEAMS_KEY, JSON.stringify(teams));

            try {
                const payload = { 
                    action: 'saveData',
                    students: students,
                    teams: teams
                };
                
                const body = new URLSearchParams();
                body.append('data', JSON.stringify(payload));

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: body
                });

                const text = await response.text();
                const data = JSON.parse(text || '{}');
                
                if (data.result !== 'success') {
                    showToast('é›²ç«¯å„²å­˜å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('Save Error:', error);
                showToast('é›²ç«¯åŒæ­¥ä¸­æ–·ï¼Œè³‡æ–™æš«å­˜æœ¬åœ°', 'warning');
            } finally {
                setTimeout(() => { isSyncing = false; }, 1000);
            }
        }

        function showLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        // --- å·¥å…·å‡½å¼ ---
        function generateTeamId() { return 'TEAM_' + new Date().getTime(); }

        function maskEmail(e, accountId) { 
            if (!e) return 'ç„¡';
            if (accountId) {
                const parts = e.split('@');
                if (parts.length === 2 && parts[0].toLowerCase() === accountId.toLowerCase()) return e;
            }
            const parts = e.split('@');
            if (parts.length === 2) {
                const local = parts[0];
                if (local.length > 2) return local[0] + '**@' + parts[1];
                if (local.length > 0) return local[0] + '*@' + parts[1];
            }
            return e;
        }

        function maskName(n) { 
            if (!n || n.length < 1) return '';
            if (n.length <= 2) return n[0] + '*';
            return n[0] + '*'.repeat(n.length - 2) + n[n.length - 1];
        }

        window.showToast = function(msg, type='info') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerText = msg;
            container.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
        }

        window.showConfirmDialog = function(msg) {
            return new Promise(resolve => {
                const d = document.getElementById('confirm-container');
                d.style.display = 'flex';
                d.innerHTML = `<div class="confirm-box"><p style="margin-bottom:20px; color:var(--text-main); font-size:1.1em;">${msg}</p><div class="action-btn-group" style="justify-content:center;"><button class="btn btn-primary" style="width:80px;">ç¢ºå®š</button> <button class="btn btn-secondary" style="width:80px;">å–æ¶ˆ</button></div></div>`;
                d.querySelector('.btn-primary').onclick = () => { d.style.display='none'; resolve(true); };
                d.querySelector('.btn-secondary').onclick = () => { d.style.display='none'; resolve(false); };
            });
        }

        window.closeModal = function(id) { document.getElementById(id).style.display = 'none'; }

        window.hideAll = function() {
            document.querySelectorAll('#login-container, #admin-login-container, #result-container, #admin-container').forEach(e => e.classList.add('hidden'));
        }

        window.showStudentLogin = function() {
            currentMode = 'student';
            window.hideAll();
            document.getElementById('login-container').classList.remove('hidden');
            document.getElementById('login-error').classList.add('hidden');
        }

        window.showAdminLogin = function() {
            window.hideAll();
            document.getElementById('admin-login-container').classList.remove('hidden');
            document.getElementById('admin-password').value = '';
        }
        
        window.switchAdminTab = function(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const activeBtn = document.querySelector(`.tab-btn[onclick="window.switchAdminTab('${tabName}')"]`);
            if(activeBtn) activeBtn.classList.add('active');
            
            ['tab-student-action', 'tab-team-action', 'tab-overview-action', 'tab-batch-action'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(`tab-${tabName}-action`).classList.remove('hidden');

            const listTitle = document.getElementById('list-title');
            const studentSearch = document.getElementById('student-search');
            const overviewSearch = document.getElementById('overview-search-container');

            if(overviewSearch) overviewSearch.classList.add('hidden');
            if(studentSearch) studentSearch.classList.remove('hidden');

            if (tabName === 'student') {
                listTitle.innerText = 'å­¸ç”Ÿåˆ—è¡¨';
                renderStudentList();
            } else if (tabName === 'team') {
                listTitle.innerText = 'åœ˜éšŠæ´»å‹•åˆ—è¡¨';
                renderTeamList();
            } else if (tabName === 'overview') {
                listTitle.innerText = 'å…¨åŸŸèªè­‰åˆ—è¡¨';
                if(overviewSearch) overviewSearch.classList.remove('hidden');
                if(studentSearch) studentSearch.classList.add('hidden');
                renderGlobalList();
            } else if (tabName === 'batch') {
                listTitle.innerText = 'ç³»çµ±èªªæ˜';
                document.getElementById('main-table-display').innerHTML = '<div style="padding:40px; text-align:center; color:var(--text-secondary);">è«‹åœ¨å·¦å´é¢æ¿æ“ä½œ</div>';
            }
        }

        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const s = students[document.getElementById('account').value.trim()];
            if (s && s.school === document.getElementById('school').value.trim() && s.class === document.getElementById('class').value.trim()) {
                displayStudentResult(s);
            } else {
                const err = document.getElementById('login-error');
                err.textContent = "è³‡æ–™éŒ¯èª¤";
                err.classList.remove('hidden');
            }
        });

        document.getElementById('admin-login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            if (document.getElementById('admin-password').value === TEACHER_PASSWORD) {
                currentMode = 'admin';
                window.hideAll();
                document.getElementById('admin-container').classList.remove('hidden');
                window.switchAdminTab('student');
                showWelcomePanel();
            } else {
                const err = document.getElementById('admin-login-error');
                err.textContent = "å¯†ç¢¼éŒ¯èª¤";
                err.classList.remove('hidden');
            }
        });

        function displayStudentResult(s) {
            currentMode = 'student';
            viewingAccountId = s.account; 
            window.hideAll();
            document.getElementById('result-container').classList.remove('hidden');
            document.getElementById('result-account').textContent = s.account;
            document.getElementById('result-name').textContent = maskName(s.name); 
            document.getElementById('result-school').textContent = s.school;
            document.getElementById('result-class').textContent = s.class;
            document.getElementById('result-email').textContent = maskEmail(s.email, s.account);

            const tbody = document.querySelector('#tasks-table-student tbody');
            tbody.innerHTML = '';
            
            if (!s.tasks) s.tasks = [];
            s.tasks.forEach(t => {
                const tr = tbody.insertRow();
                tr.innerHTML = `
                    <td><div style="font-weight:500;">${t.name}</div></td>
                    <td><span class="badge status-${t.status}">${t.status}</span></td>
                    <td style="text-align:right;"></td>`;
                const td = tr.cells[2];
                const visibleCount = (t.comments || []).filter(c => !c.isRecalled).length;
                let btns = `<span class="action-btn-group"><button class="btn btn-secondary btn-small" onclick="window.openCommentModal('${s.account}', ${t.id}, 'student', false)">ç•™è¨€ (${visibleCount})</button>`;
                if (t.status === 'æœªå®Œæˆ' || t.status === 'èªè­‰å¤±æ•—') {
                    btns += ` <button class="btn btn-primary btn-small" onclick="window.reqCert('${s.account}', ${t.id}, false)">è«‹æ±‚èªè­‰</button>`;
                } else if (t.status === 'å·²èªè­‰') {
                    btns += ` <button class="btn btn-warning btn-small" onclick="window.reqReCert('${s.account}', ${t.id}, false)">é‡æ–°å¯©æ ¸</button>`;
                }
                btns += `</span>`;
                td.innerHTML = btns;
            });

            const myTeams = (s.joinedTeams || []).filter(tid => teams[tid]);
            if (myTeams.length > 0) {
                const sepRow = tbody.insertRow();
                sepRow.innerHTML = `<td colspan="3" style="background:#f8fafc; text-align:center; color:var(--text-secondary); font-weight:600; padding:12px;">- åœ˜éšŠæ´»å‹• -</td>`;
                myTeams.forEach(tid => {
                    const t = teams[tid];
                    const tr = tbody.insertRow();
                    tr.innerHTML = `
                        <td><div style="font-weight:500;"><span class="team-badge">åœ˜éšŠ</span>${t.name}</div></td>
                        <td><span class="badge status-${t.status}">${t.status}</span></td>
                        <td style="text-align:right;"></td>`;
                    const td = tr.cells[2];
                    const visibleCount = (t.comments || []).filter(c => !c.isRecalled).length;
                    let btns = `<span class="action-btn-group"><button class="btn btn-secondary btn-small" onclick="window.openCommentModal('${tid}', 0, 'student', true)">ç•™è¨€ (${visibleCount})</button>`;
                    if (t.status === 'æœªå®Œæˆ' || t.status === 'èªè­‰å¤±æ•—') {
                        btns += ` <button class="btn btn-primary btn-small" onclick="window.reqCert('${tid}', 0, true)">è«‹æ±‚åœ˜éšŠèªè­‰</button>`;
                    } else if (t.status === 'å·²èªè­‰') {
                        btns += ` <button class="btn btn-warning btn-small" onclick="window.reqReCert('${tid}', 0, true)">é‡æ–°å¯©æ ¸</button>`;
                    }
                    btns += `</span>`;
                    td.innerHTML = btns;
                });
            }
        }

        window.logout = () => { window.showToast('å·²ç™»å‡º'); window.showStudentLogin(); }
        window.adminLogout = () => { window.showToast('å·²ç™»å‡º'); window.showStudentLogin(); }

        window.reqCert = async function(id, tid, isTeam) {
            if (await window.showConfirmDialog('ç¢ºå®šç”³è«‹èªè­‰ï¼Ÿ')) {
                if (isTeam) { teams[id].status = 'å¯©æ ¸ä¸­'; } 
                else { students[id].tasks.find(t=>t.id==tid).status = 'å¯©æ ¸ä¸­'; }
                await pushDataToSheet();
                displayStudentResult(students[viewingAccountId]);
                window.showToast('å·²ç”³è«‹', 'success');
            }
        }
        window.reqReCert = async function(id, tid, isTeam) {
            if (await window.showConfirmDialog('ç¢ºå®šé‡æ–°æäº¤ï¼Ÿ')) {
                if (isTeam) { teams[id].status = 'å¯©æ ¸ä¸­'; } 
                else { students[id].tasks.find(t=>t.id==tid).status = 'å¯©æ ¸ä¸­'; }
                await pushDataToSheet();
                displayStudentResult(students[viewingAccountId]);
                window.showToast('å·²é‡æ–°æäº¤', 'success');
            }
        }

        function renderStudentList() {
            const table = document.getElementById('main-table-display');
            const term = document.getElementById('student-search').value.toLowerCase();
            table.innerHTML = `<thead><tr><th>å­¸è™Ÿ</th><th>å§“å</th> <th style="text-align:right; width:140px;">æ“ä½œ</th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            Object.keys(students).sort().forEach(k => {
                const s = students[k];
                if (k.toLowerCase().includes(term) || s.name.toLowerCase().includes(term)) {
                    const tr = tbody.insertRow();
                    tr.insertCell().textContent = k;
                    tr.insertCell().textContent = s.name;
                    tr.insertCell().innerHTML = `
                        <div class="action-btn-group" style="justify-content:flex-end;">
                            <button class="btn btn-primary btn-small" onclick="window.editStudent('${k}')">ç·¨è¼¯</button>
                            <button class="btn btn-danger btn-small" onclick="window.delStudent('${k}')">åˆªé™¤</button>
                        </div>`;
                }
            });
        }
        window.filterStudentList = renderStudentList;

        window.showWelcomePanel = async function() {
            if (editingStudentId && await window.showConfirmDialog('æœªå„²å­˜ï¼Œç¢ºå®šè¿”å›ï¼Ÿ')) {
                editingStudentId = null;
                document.getElementById('admin-welcome-panel').classList.remove('hidden');
                document.getElementById('student-form-panel').classList.add('hidden');
            } else if (!editingStudentId) {
                document.getElementById('admin-welcome-panel').classList.remove('hidden');
                document.getElementById('student-form-panel').classList.add('hidden');
            }
        }

        window.showStudentForm = function(mode) {
            document.getElementById('admin-welcome-panel').classList.add('hidden');
            document.getElementById('student-form-panel').classList.remove('hidden');
            if (mode === 'new') window.switchToNewStudentMode(false);
        }

        window.switchToNewStudentMode = async function(confirmIt = true) {
            if (confirmIt && editingStudentId) { if (!await window.showConfirmDialog('ç¢ºå®šåˆ‡æ›ï¼Ÿ')) return; }
            editingStudentId = null;
            const form = document.getElementById('student-form');
            if (form) form.reset();
            document.getElementById('admin-school').value = 'æ°¸é–é«˜å·¥';
            document.getElementById('admin-class').value = 'è³‡è¨ŠäºŒ';
            const tbody = document.querySelector('#tasks-table-admin tbody');
            if (tbody) tbody.innerHTML = '';
            
            document.getElementById('submit-student-btn').innerText = 'æ–°å¢å­¸ç”Ÿ';
            document.getElementById('submit-student-btn').className = 'btn btn-primary';
            document.getElementById('switch-to-new-student-btn').classList.add('hidden');
            document.getElementById('admin-account').readOnly = false;
        }

        window.editStudent = function(id) {
            const s = students[id];
            editingStudentId = id;
            document.getElementById('admin-welcome-panel').classList.add('hidden');
            document.getElementById('student-form-panel').classList.remove('hidden');
            document.getElementById('submit-student-btn').innerText = 'å„²å­˜è®Šæ›´';
            document.getElementById('submit-student-btn').className = 'btn btn-success';
            document.getElementById('switch-to-new-student-btn').classList.remove('hidden');
            const form = document.getElementById('student-form');
            document.getElementById('admin-account').value = s.account;
            document.getElementById('admin-account').readOnly = true;
            document.getElementById('admin-name').value = s.name;
            document.getElementById('admin-school').value = s.school;
            document.getElementById('admin-class').value = s.class;
            document.getElementById('admin-email').value = s.email;
            const tbody = document.querySelector('#tasks-table-admin tbody');
            tbody.innerHTML = '';
            (s.tasks || []).forEach(t => addTaskRow(t));
        }

        window.addTaskRow = function(task=null) {
            const isNew = !task;
            const tid = isNew ? nextTaskId++ : task.id;
            const tbody = document.querySelector('#tasks-table-admin tbody');
            const tr = tbody.insertRow();
            tr.setAttribute('data-id', tid);
            const name = task ? task.name : '';
            const status = task ? task.status : 'æœªå®Œæˆ';
            const comments = task ? task.comments : [];
            const commentCount = comments.filter(c=>!c.isRecalled).length;
            
            tr.innerHTML = `
                <td><input type="text" class="task-name" value="${name}" placeholder="é …ç›®åç¨±" required style="border:none; background:transparent; font-weight:500; width:95%;"></td>
                <td>
                    <select class="task-status" style="width:95%; border:1px solid var(--border); border-radius:4px; font-size:0.8em;">
                        <option value="æœªå®Œæˆ" ${status=='æœªå®Œæˆ'?'selected':''}>æœªå®Œæˆ</option>
                        <option value="å¯©æ ¸ä¸­" ${status=='å¯©æ ¸ä¸­'?'selected':''}>å¯©æ ¸ä¸­</option>
                        <option value="èªè­‰å¤±æ•—" ${status=='èªè­‰å¤±æ•—'?'selected':''}>å¤±æ•—</option>
                        <option value="å·²èªè­‰" ${status=='å·²èªè­‰'?'selected':''}>å·²èªè­‰</option>
                    </select>
                </td>
                <td style="text-align:center;"><button class="btn btn-secondary btn-small" onclick="window.openCommentModal('${editingStudentId||''}', ${tid}, 'admin', false)" ${!editingStudentId?'disabled':''}>ğŸ’¬${commentCount}</button></td>
                <td style="text-align:center; width:10px;"><button class="btn btn-danger btn-small" style="padding:2px 6px; font-size:12px;" onclick="this.closest('tr').remove()">âœ•</button></td>
            `;
        }

        document.getElementById('student-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('admin-account').value.trim();
            if (!editingStudentId && students[id]) { window.showToast('å­¸è™Ÿé‡è¤‡', 'error'); return; }
            
            const tasks = [];
            const rows = document.querySelectorAll('#tasks-table-admin tbody tr');
            rows.forEach(r => {
                const tid = parseInt(r.getAttribute('data-id'));
                const existingStudent = students[editingStudentId || id];
                const existingTask = existingStudent ? (existingStudent.tasks || []).find(x=>x.id==tid) : null;
                tasks.push({
                    id: tid, name: r.querySelector('.task-name').value.trim(),
                    status: r.querySelector('.task-status').value,
                    teacherComment: existingTask ? existingTask.teacherComment : 'ç„¡',
                    comments: existingTask ? existingTask.comments : []
                });
            });
            
            students[id] = {
                account: id, name: document.getElementById('admin-name').value.trim(),
                school: document.getElementById('admin-school').value.trim(),
                class: document.getElementById('admin-class').value.trim(),
                email: document.getElementById('admin-email').value.trim(), tasks: tasks,
                joinedTeams: (students[id] ? students[id].joinedTeams : [])
            };
            
            await pushDataToSheet();
            renderStudentList();
            window.showToast('å„²å­˜æˆåŠŸ', 'success');
            if (!editingStudentId) window.switchToNewStudentMode(false); 
        });

        window.delStudent = async function(id) {
            if (await window.showConfirmDialog('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                (students[id].joinedTeams || []).forEach(tid => {
                    if(teams[tid]) { teams[tid].members = teams[tid].members.filter(m => m !== id); }
                });
                delete students[id];
                await pushDataToSheet();
                renderStudentList();
            }
        }

        function renderTeamList() {
            const table = document.getElementById('main-table-display');
            const keys = Object.keys(teams);
            table.innerHTML = `<thead><tr><th>æ´»å‹•åç¨±</th><th>æ¨¡å¼</th><th>æˆå“¡</th><th style="text-align:right; width:160px;">æ“ä½œ</th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            
            if (keys.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px; color:var(--text-secondary);">ç›®å‰å°šç„¡åœ˜éšŠæ´»å‹•</td></tr>';
                return;
            }
            keys.forEach(tid => {
                const t = teams[tid];
                const tr = tbody.insertRow();
                tr.innerHTML = `
                    <td>
                        <div style="font-weight:600; margin-bottom:4px;">${t.name}</div>
                        <div style="font-size:0.8em; color:var(--text-secondary);">ç‹€æ…‹: ${t.status}</div>
                    </td>
                    <td>${t.joinMode==='open'?'<span class="badge" style="background:#ecfdf5; color:#10b981;">é–‹æ”¾</span>':'<span class="badge" style="background:#fff7ed; color:#f59e0b;">é™åˆ¶</span>'}</td>
                    <td style="text-align:center; font-weight:600;">${(t.members||[]).length}</td>
                    <td style="text-align:right;">
                        <div class="action-btn-group" style="justify-content:flex-end;">
                            <button class="btn btn-info btn-small" onclick="window.openCommentModal('${tid}', 0, 'admin', true)">ğŸ’¬ ${(t.comments||[]).filter(c=>!c.isRecalled).length}</button>
                            <button class="btn btn-primary btn-small" onclick="window.openTeamModal('${tid}')">ç®¡ç†</button>
                            <button class="btn btn-danger btn-small" onclick="window.delTeam('${tid}')">åˆªé™¤</button>
                        </div>
                    </td>`;
            });
        }

        window.openTeamModal = function(teamId) {
            editingTeamId = teamId || null;
            const modal = document.getElementById('team-modal');
            modal.style.display = 'flex';
            const form = document.getElementById('team-form');
            const delBtn = document.getElementById('delete-team-btn');
            
            if (teamId) {
                const t = teams[teamId];
                document.getElementById('team-modal-title').innerText = `ç®¡ç†åœ˜éšŠ: ${t.name}`;
                document.getElementById('team-name').value = t.name;
                document.getElementById('team-edit-id').value = t.id;
                document.getElementById('team-join-mode').value = t.joinMode;
                document.getElementById('team-status').value = t.status;
                delBtn.classList.remove('hidden');
                delBtn.onclick = async () => { await window.delTeam(teamId); window.closeModal('team-modal'); };
            } else {
                document.getElementById('team-modal-title').innerText = 'æ–°å¢åœ˜éšŠæ´»å‹•';
                document.getElementById('team-edit-id').value = '';
                document.getElementById('team-name').value = '';
                document.getElementById('team-join-mode').value = 'open';
                document.getElementById('team-status').value = 'æœªå®Œæˆ';
                delBtn.classList.add('hidden');
            }
            renderTeamMembers();
        }

        document.getElementById('team-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('team-edit-id').value || generateTeamId();
            const isNew = !teams[id];
            
            teams[id] = {
                id: id, name: document.getElementById('team-name').value.trim(),
                status: document.getElementById('team-status').value, joinMode: document.getElementById('team-join-mode').value,
                members:isNew ? [] : teams[id].members, comments: isNew ? [] : teams[id].comments
            };
            await pushDataToSheet();
            renderTeamList();
            window.closeModal('team-modal');
            window.showToast('å·²å„²å­˜', 'success');
        });

        window.delTeam = async function(id) {
            if (await window.showConfirmDialog('ç¢ºå®šåˆªé™¤æ­¤æ´»å‹•ï¼Ÿæˆå“¡å°‡æœƒè¢«ç§»é™¤ã€‚')) {
                const t = teams[id];
                t.members.forEach(mId => {
                    if (students[mId]) { students[mId].joinedTeams = students[mId].joinedTeams.filter(tid => tid !== id); }
                });
                delete teams[id];
                await pushDataToSheet();
                renderTeamList();
            }
        }

        function renderTeamMembers() {
            const list = document.getElementById('team-members-list');
            list.innerHTML = '';
            if (!editingTeamId) return;
            const t = teams[editingTeamId];
            (t.members || []).forEach(mid => {
                const s = students[mid];
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.style.alignItems = 'center';
                div.style.padding = '6px 0';
                div.style.borderBottom = '1px solid var(--border)';
                div.innerHTML = `<span style="font-size:0.9em;">${mid} <span style="color:#94a3b8; font-size:0.8em;">(${s ? s.name : 'æœªçŸ¥ç”¨æˆ¶'})</span></span><button class="btn btn-danger btn-small" style="padding:2px 8px; font-size:12px;" onclick="window.removeMember('${mid}')">ç§»é™¤</button>`;
                list.appendChild(div);
            });
        }

        window.addMemberToTeam = async function() {
            if (!editingTeamId) return;
            const input = document.getElementById('team-add-member-input');
            const mid = input.value.trim();
            const t = teams[editingTeamId];
            
            if (!students[mid]) { window.showToast('å­¸è™Ÿä¸å­˜åœ¨', 'error'); return; }
            if ((t.members || []).includes(mid)) { window.showToast('å·²åœ¨åœ˜éšŠä¸­', 'error'); return; }
            
            if(!t.members) t.members = [];
            t.members.push(mid);
            
            if (!students[mid].joinedTeams) students[mid].joinedTeams = [];
            students[mid].joinedTeams.push(editingTeamId);
            
            await pushDataToSheet();
            input.value = '';
            renderTeamMembers();
            renderTeamList();
            window.showToast('æˆå“¡å·²åŠ å…¥', 'success');
        }

        window.removeMember = async function(mid) {
            if (!confirm(`ç¢ºå®šç§»é™¤ ${mid}?`)) return;
            const t = teams[editingTeamId];
            t.members = t.members.filter(id => id !== mid);
            if (students[mid]) { students[mid].joinedTeams = students[mid].joinedTeams.filter(tid => tid !== editingTeamId); }
            await pushDataToSheet();
            renderTeamMembers();
            renderTeamList();
        }

        window.openTeamJoinModal = function() {
            const modal = document.getElementById('team-join-modal');
            const list = document.getElementById('available-teams-list');
            list.innerHTML = '';
            
            const myId = viewingAccountId;
            const myTeams = students[myId] ? (students[myId].joinedTeams || []) : [];
            const available = Object.keys(teams).filter(tid => {
                const t = teams[tid];
                return t.joinMode === 'open' && !myTeams.includes(tid);
            });

            if (available.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:var(--text-secondary); padding:40px;">ç›®å‰æ²’æœ‰å¯åŠ å…¥çš„é–‹æ”¾åœ˜éšŠæ´»å‹•ã€‚</p>';
            } else {
                available.forEach(tid => {
                    const t = teams[tid];
                    const div = document.createElement('div');
                    div.className = 'team-list-item';
                    div.innerHTML = `
                        <div class="team-info">
                            <h4 style="font-size:1em;">${t.name}</h4>
                            <p>æˆå“¡: ${(t.members||[]).length} äºº | ç‹€æ…‹: ${t.status}</p>
                        </div>
                        <button class="btn btn-info" onclick="window.joinTeam('${tid}')">åŠ å…¥</button>`;
                    list.appendChild(div);
                });
            }
            modal.style.display = 'flex';
        }

        window.joinTeam = async function(tid) {
            const t = teams[tid];
            const sid = viewingAccountId;
            if (!students[sid]) { window.showToast('ç”¨æˆ¶è³‡æ–™éŒ¯èª¤', 'error'); return; }
            
            if(!t.members) t.members = [];
            t.members.push(sid);
            
            if (!students[sid].joinedTeams) students[sid].joinedTeams = [];
            students[sid].joinedTeams.push(tid);
            
            await pushDataToSheet();
            window.showToast('æˆåŠŸåŠ å…¥åœ˜éšŠ', 'success');
            window.closeModal('team-join-modal');
            displayStudentResult(students[sid]);
        }

        function renderGlobalList() {
            const table = document.getElementById('main-table-display');
            const textSearch = document.getElementById('overview-text-search').value.toLowerCase();
            const typeFilter = document.getElementById('overview-type-filter').value; 
            const statusFilter = document.getElementById('overview-status-filter').value; 
            
            let listData = [];
            let displayCount = 0, displayCertified = 0, displayFailed = 0;

            Object.keys(students).forEach(acct => {
                const s = students[acct];
                (s.tasks || []).forEach(t => {
                    if (typeFilter === 'team') return; 
                    if (statusFilter === 'todo' && t.status === 'å·²èªè­‰') return;
                    if (statusFilter === 'certified' && t.status !== 'å·²èªè­‰') return;
                    if (statusFilter === 'failed' && t.status !== 'èªè­‰å¤±æ•—') return;

                    if (textSearch) {
                        const taskName = t.name.toLowerCase();
                        const studentName = s.name.toLowerCase();
                        if (!taskName.includes(textSearch) && !studentName.includes(textSearch)) return;
                    }

                    displayCount++;
                    if(t.status === 'å·²èªè­‰') displayCertified++;
                    if(t.status === 'æœªå®Œæˆ' || t.status === 'èªè­‰å¤±æ•—' || t.status === 'å¯©æ ¸ä¸­') displayFailed++;

                    listData.push({
                        type: 'personal', name: t.name, status: t.status,
                        targetName: s.name, targetId: acct, taskId: t.id,
                        commentCount: (t.comments||[]).filter(c=>!c.isRecalled).length
                    });
                });
            });

            Object.keys(teams).forEach(tid => {
                const t = teams[tid];
                if (typeFilter === 'personal') return; 
                if (statusFilter === 'todo' && t.status === 'å·²èªè­‰') return;
                if (statusFilter === 'certified' && t.status !== 'å·²èªè­‰') return;
                if (statusFilter === 'failed' && t.status !== 'èªè­‰å¤±æ•—') return;

                if (textSearch) {
                    const teamName = t.name.toLowerCase();
                    if (!teamName.includes(textSearch)) return;
                }

                displayCount++;
                if(t.status === 'å·²èªè­‰') displayCertified++;
                if(t.status === 'æœªå®Œæˆ' || t.status === 'èªè­‰å¤±æ•—' || t.status === 'å¯©æ ¸ä¸­') displayFailed++;

                listData.push({
                    type: 'team', name: t.name, status: t.status,
                    targetName: `åœ˜éšŠ (${(t.members||[]).length}äºº)`, targetId: tid, taskId: 0,
                    commentCount: (t.comments||[]).filter(c=>!c.isRecalled).length
                });
            });

            document.getElementById('filtered-count').textContent = displayCount;
            document.getElementById('filtered-certified').textContent = displayCertified;
            document.getElementById('filtered-failed').textContent = displayFailed;

            table.innerHTML = `<thead><tr><th>é¡å‹</th><th>é …ç›®åç¨±</th><th>å°è±¡</th><th>ç‹€æ…‹</th><th style="text-align:right;">æ“ä½œ</th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            
            if (listData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px; color:var(--text-secondary);">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„é …ç›®</td></tr>`;
                return;
            }

            listData.forEach(item => {
                const tr = tbody.insertRow();
                const typeBadge = item.type === 'personal' 
                    ? `<span class="type-badge-group type-personal">å€‹äºº</span>` 
                    : `<span class="type-badge-group type-team">åœ˜éšŠ</span>`;
                const statusBadge = `<span class="badge status-${item.status}">${item.status}</span>`;
                
                let actionBtns = '';
                if (item.type === 'personal') {
                    actionBtns = `
                        <div class="action-btn-group" style="justify-content:flex-end;">
                            <button class="btn btn-secondary btn-small" onclick="window.openCommentModal('${item.targetId}', ${item.taskId}, 'admin', false)" title="ç•™è¨€">ğŸ’¬${item.commentCount}</button>
                            <button class="btn btn-primary btn-small" onclick="window.editStudent('${item.targetId}')" title="ç·¨è¼¯å­¸ç”Ÿ">ç·¨è¼¯</button>
                        </div>`;
                } else {
                    actionBtns = `
                        <div class="action-btn-group" style="justify-content:flex-end;">
                            <button class="btn btn-secondary btn-small" onclick="window.openCommentModal('${item.targetId}', 0, 'admin', true)" title="ç•™è¨€">ğŸ’¬${item.commentCount}</button>
                            <button class="btn btn-primary btn-small" onclick="window.openTeamModal('${item.targetId}')" title="ç®¡ç†åœ˜éšŠ">ç®¡ç†</button>
                        </div>`;
                }

                tr.innerHTML = `
                    <td style="width: 80px;">${typeBadge}</td>
                    <td><div style="font-weight:500;">${item.name}</div></td>
                    <td style="color:var(--text-secondary); font-size:0.9em;">${item.targetName}</td>
                    <td>${statusBadge}</td>
                    <td style="text-align:right;">${actionBtns}</td>`;
            });
        }

        window.openCommentModal = function(itemId, taskId, mode, isTeam) {
            viewingAccountId = itemId; viewingTaskId = taskId; currentMode = mode; viewingIsTeam = isTeam;
            let comments = []; let taskName = '';
            
            if (isTeam) { const t = teams[itemId]; taskName = t.name; comments = t.comments || []; } 
            else { const s = students[itemId]; const task = (s.tasks||[]).find(x=>x.id==taskId); if(!task) return; taskName = task.name; comments = task.comments || []; }

            document.getElementById('modal-title').innerText = `ç•™è¨€æ¿: ${taskName}`;
            renderCommentHistory(comments, mode, isTeam);
            const submitBtn = document.getElementById('submit-comment-btn');
            const inputArea = document.getElementById('comment-input');
            inputArea.value = '';
            
            submitBtn.onclick = async function() {
                const txt = document.getElementById('comment-input').value.trim();
                if(!txt) return;
                const newComment = { senderIdForName: mode === 'admin' ? 'teacher' : viewingAccountId, content: txt, timestamp: new Date().toLocaleString('zh-TW'), isRecalled: false };
                if (isTeam) { 
                    if(!teams[itemId].comments) teams[itemId].comments = [];
                    teams[itemId].comments.push(newComment); 
                } else { 
                    const taskList = students[itemId].tasks || [];
                    const task = taskList.find(x=>x.id==taskId);
                    if(!task.comments) task.comments = [];
                    task.comments.push(newComment); 
                }
                await pushDataToSheet(); // Sync
                inputArea.value = '';
                renderCommentHistory(isTeam ? (teams[itemId].comments||[]) : (students[itemId].tasks.find(x=>x.id==taskId).comments||[]), mode, isTeam); 
                if(currentMode !== 'admin') displayStudentResult(students[viewingAccountId]); 
                else {
                    const activeTab = document.querySelector('button.tab-btn.active').innerText;
                    if(activeTab.includes('èªè­‰ç¸½è¦½')) renderGlobalList();
                    else if(activeTab.includes('å­¸ç”Ÿè³‡æ–™')) renderStudentList();
                    else renderTeamList();
                }
            };
            document.getElementById('comment-modal').style.display = 'flex';
        }

        function renderCommentHistory(comments, viewMode, isTeam) {
            const container = document.getElementById('comment-history');
            container.innerHTML = '';
            comments.forEach((c, index) => {
                const div = document.createElement('div');
                let classType = c.senderIdForName === 'teacher' ? 'comment-teacher' : 'comment-student';
                if (c.isRecalled) classType += ' comment-recalled';
                div.className = `comment ${classType}`;
                let senderName = c.senderIdForName === 'teacher' ? 'æ•™å¸«' : c.senderIdForName;
                if (c.senderIdForName !== 'teacher' && students[c.senderIdForName]) senderName = students[c.senderIdForName].name;
                let contentHTML = c.isRecalled ? `<span style="font-style:italic">æ­¤ç•™è¨€å·²è¢«æ’¤å›</span>` : c.content;
                let actionButtons = '';
                if (!c.isRecalled) {
                    const isMyComment = (viewMode === 'student' && c.senderIdForName === viewingAccountId) || (viewMode === 'admin' && c.senderIdForName === 'teacher');
                    if (isMyComment) actionButtons += `<button class="btn btn-secondary btn-small" style="margin-top:8px; background:rgba(255,255,255,0.8);" onclick="window.handleCommentAction(${index}, 'recall', ${isTeam})">æ’¤å›</button>`;
                }
                div.innerHTML = `<div class="comment-header"><span>${senderName}</span><span style="font-weight:400; font-size:0.8em; color:var(--text-secondary);">${c.timestamp}</span></div><div>${contentHTML}</div><div class="comment-actions">${actionButtons}</div>`;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }

        window.handleCommentAction = async function(index, action, isTeam) {
            if (action === 'recall' && !await window.showConfirmDialog('ç¢ºå®šè¦æ’¤å›é€™å‰‡ç•™è¨€å—ï¼Ÿ')) return;
            let comments; let saveFn;
            if (isTeam) { comments = teams[viewingAccountId].comments || []; saveFn = pushDataToSheet; } 
            else { const t = students[viewingAccountId].tasks.find(x=>x.id==viewingTaskId); comments = t.comments || []; saveFn = pushDataToSheet; }
            const c = comments[index];
            if (action === 'recall') c.isRecalled = true;
            await saveFn();
            renderCommentHistory(comments, currentMode, isTeam);
            const activeTab = document.querySelector('button.tab-btn.active').innerText;
            if(activeTab.includes('èªè­‰ç¸½è¦½')) renderGlobalList();
            else if(activeTab.includes('å­¸ç”Ÿè³‡æ–™')) renderStudentList();
            else renderTeamList();
            
            window.showToast('ç•™è¨€å·²æ’¤å›', 'success');
        }

        window.exportData = () => {
            const data = { students: students, teams: teams };
            const d = JSON.stringify(data, null, 2);
            const a = document.createElement('a');
            a.href = 'data:text/json;charset=utf-8,'+encodeURIComponent(d);
            a.download = 'system_backup.json';
            a.click();
        }

        // æ‰¹é‡ç›¸é—œåŠŸèƒ½
        function parseParams(paramString) {
            const params = {};
            if (!paramString) return params;
            let cleanStr = paramString.replace(/ï¼Œ/g, ',').replace(/ï¼›/g, ';').replace(/ï½›/g, '{').replace(/ï½/g, '}').replace(/^\{|\}$/g, '');
            try {
                const items = cleanStr.split(/[,;]/); 
                items.forEach(item => {
                    let p = item.trim();
                    if (!p) return;
                    if (p.includes('=')) {
                        const idx = p.indexOf('=');
                        const k = p.substring(0, idx).trim();
                        const v = p.substring(idx + 1).trim();
                        if (v.includes(',')) { params[k] = v.split(',').map(s => s.trim()); } else { params[k] = v; }
                    } else { params[p] = true; }
                });
            } catch(e) { console.error("Parse Error", e); }
            return params;
        }

        function parseRule(ruleStr, context) {
            try {
                let result = ruleStr;
                result = result.replace(/\$([^\$]+)\$/g, (match, constant) => constant);
                result = result.replace(/\[([^\[\{]+)\](?:\{([^\}]*)\})?/g, (match, ruleName, args) => {
                    const params = parseParams(args);
                    let output = "";
                    const now = new Date();
                    switch(ruleName.trim()) {
                        case 'number': let num = context.baseNum; if(params.start) num = (context.ruleIndex - 1) + parseInt(params.start); output = params.num ? num.toString().padStart(parseInt(params.num), '0') : num.toString(); break;
                        case 'year': let y = now.getFullYear(); output = params.national === 'roc' ? (y - 1911).toString() : y.toString(); break;
                        case 'date': const yyyy = now.getFullYear(); const yy = (yyyy % 100).toString().padStart(2,'0'); const mm = (now.getMonth()+1).toString().padStart(2,'0'); const dd = now.getDate().toString().padStart(2,'0'); if (params.yyyymmdd) output = yyyy + mm + dd; else if (params.ddmmyyyy) output = dd + mm + yyyy; else if (params.yymmdd) output = yy + mm + dd; else if (params.ddmm) output = dd + mm; else if (params.mmdd) output = mm + dd; else output = yyyy + '/' + mm + '/' + dd; break;
                        case 'time': const hh = now.getHours().toString().padStart(2,'0'); const min = now.getMinutes().toString().padStart(2,'0'); const ss = now.getSeconds().toString().padStart(2,'0'); output = (params.format === 'hhmm') ? (hh + min) : (hh + min + ss); break;
                        case 'rand': let digits = parseInt(params.num) || 4; let max = Math.pow(10, digits) - 1; let r = Math.floor(Math.random() * (max + 1)); output = r.toString().padStart(digits, '0'); break;
                        case 'student_num': output = context.studentNum || ""; break;
                        default: output = match;
                    }
                    return output;
                });
                return result;
            } catch(e) { console.error("Rule Error", e); return "ERROR"; }
        }

        window.updatePreview = function() {
            const startInput = parseInt(document.getElementById('batch-start').value);
            const rule = document.getElementById('batch-rule-account').value;
            const previewEl = document.getElementById('batch-preview');
            if (!rule.trim()) { previewEl.textContent = 'è«‹è¼¸å…¥å­¸è™Ÿè¦å‰‡'; return; }
            if (isNaN(startInput)) { previewEl.textContent = 'èµ·å§‹éŒ¯èª¤'; return; }
            let html = '';
            for (let i = 0; i < 3; i++) {
                const ctx = { ruleIndex: i+1, baseNum: startInput + i, studentNum: '' };
                const res = parseRule(rule, ctx);
                html += `${startInput + i}: ${res}\n`;
            }
            previewEl.textContent = html;
        }

        window.prepareBatchReview = function() {
            const startInput = parseInt(document.getElementById('batch-start').value);
            const endInput = parseInt(document.getElementById('batch-end').value);
            const cls = document.getElementById('batch-class').value;
            const school = (document.getElementById('batch-school')?.value) || 'æ°¸é–é«˜å·¥';
            const ruleAccount = document.getElementById('batch-rule-account').value;
            let ruleEmail = document.getElementById('batch-rule-email').value.trim();

            if (isNaN(startInput) || isNaN(endInput) || startInput > endInput) { window.showToast('è™Ÿç¢¼ç¯„åœéŒ¯èª¤', 'error'); return; }
            if (!ruleAccount) { window.showToast('è«‹è¼¸å…¥å­¸è™Ÿè¦å‰‡', 'error'); return; }
            let notList = [];
            const numParamsMatch = ruleAccount.match(/\[number\](?:\{([^\}]*)\})?/);
            if (numParamsMatch) {
                const params = parseParams(numParamsMatch[1]);
                if (params.not) notList = Array.isArray(params.not) ? params.not.map(n => parseInt(n)) : [parseInt(params.not)];
            }
            pendingBatchList = [];
            for (let i = startInput; i <= endInput; i++) {
                if (notList.includes(i)) continue;
                const ctx = { ruleIndex: i, baseNum: i };
                const finalAccount = parseRule(ruleAccount, ctx);
                if (finalAccount === "ERROR") continue;
                if (students[finalAccount]) continue;
                let finalEmail = '';
                if (ruleEmail) {
                    const emailCtx = { ruleIndex: i, baseNum: i, studentNum: finalAccount };
                    finalEmail = parseRule(ruleEmail, emailCtx);
                }
                pendingBatchList.push({ school: school, class: cls, account: finalAccount, name: 'å¾…è¼¸å…¥', email: finalEmail });
            }
            window.closeModal('batch-modal');
            window.openBatchReviewModal();
        }

        window.openBatchReviewModal = function() {
            const modal = document.getElementById('batch-review-modal');
            modal.style.display = 'flex';
            document.getElementById('review-global-school').value = '';
            document.getElementById('review-global-class').value = '';
            renderBatchReviewTable();
        }

        function renderBatchReviewTable() {
            const tbody = document.getElementById('review-table-body');
            tbody.innerHTML = '';
            if (pendingBatchList.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:40px;">æ²’æœ‰è³‡æ–™</td></tr>'; return; }
            pendingBatchList.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><input type="text" data-idx="${index}" data-field="school" value="${item.school}"></td><td><input type="text" data-idx="${index}" data-field="class" value="${item.class}"></td><td><input type="text" data-idx="${index}" data-field="account" value="${item.account}"></td><td><input type="text" data-idx="${index}" data-field="name" value="${item.name}"></td><td><input type="text" data-idx="${index}" data-field="email" value="${item.email || ''}"></td>`;
                tbody.appendChild(tr);
            });
        }

        function setupGlobalListeners() {
            const updateSchool = document.getElementById('review-global-school');
            const updateClass = document.getElementById('review-global-class');
            const handleUpdate = (field, inputEl) => { const val = inputEl.value; if (!val) return; const inputs = document.querySelectorAll(`input[data-field="${field}"]`); inputs.forEach(inp => inp.value = val); };
            updateSchool.addEventListener('input', () => handleUpdate('school', updateSchool));
            updateClass.addEventListener('input', () => handleUpdate('class', updateClass));
        }
        setupGlobalListeners();

        document.getElementById('review-table-body').addEventListener('input', function(e) {
            if(e.target.tagName === 'INPUT') { const idx = e.target.dataset.idx; const field = e.target.dataset.field; pendingBatchList[idx][field] = e.target.value; }
        });

        window.finalizeBatchAdd = async function() {
            if (pendingBatchList.length === 0) { window.showToast('æ²’æœ‰è³‡æ–™å¯å„²å­˜', 'error'); return; }
            if (!await window.showConfirmDialog(`ç¢ºå®šæ–°å¢ ${pendingBatchList.length} ç­†å­¸ç”Ÿè³‡æ–™ï¼Ÿ`)) return;
            let count = 0; let errors = [];
            for (const s of pendingBatchList) { if (students[s.account]) { errors.push(`å­¸è™Ÿ ${s.account} å·²å­˜åœ¨`); } }
            if (errors.length > 0) { window.showToast(`ç™¼ç”ŸéŒ¯èª¤:\n${errors.join('\n')}`, 'error'); return; }
            for (const s of pendingBatchList) {
                students[s.account] = { account: s.account, name: s.name, school: s.school, class: s.class, email: s.email, tasks: [], joinedTeams: [] }; count++;
            }
            await pushDataToSheet(); 
            
            window.switchAdminTab('student'); 
            
            showToast(`æˆåŠŸæ–°å¢ ${count} ä½å­¸ç”Ÿ`, 'success'); 
            window.closeModal('batch-review-modal');
        }
        window.openBatchModal = function() { document.getElementById('batch-modal').style.display = 'flex'; window.updatePreview(); }

        // --- åˆå§‹åŒ– ---
        window.onload = async function() {
            await fetchDataFromSheet();
        }

    </script>
</body>
</html>
