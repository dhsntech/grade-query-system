<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•/æˆç¸¾èªè­‰æŸ¥è©¢ç³»çµ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600&family=Orbitron:wght@500;700&family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS è®Šæ•¸å®šç¾© (é è¨­ä¸»é¡Œ - æ·ºè‰²) --- */
        :root {
            --primary: #3b82f6; --primary-hover: #2563eb; --primary-light: #eff6ff;
            --success: #10b981; --success-hover: #059669; --success-light: #ecfdf5;
            --danger: #ef4444; --danger-hover: #dc2626; --danger-light: #fef2f2;
            --warning: #f59e0b; --warning-hover: #d97706;
            --info: #6366f1; --info-hover: #4f46e5;
            
            --bg-body: #f1f5f9; 
            --bg-card: #ffffff;
            --bg-input: #ffffff;
            --bg-overlay: rgba(15, 23, 42, 0.6);
            
            --text-main: #1e293b; 
            --text-secondary: #64748b;
            --border: #e2e8f0;
            
            --radius-sm: 6px; 
            --radius-md: 12px;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            
            --font-heading: 'Noto Sans TC', sans-serif;
            --anim-speed: 0.4s;
        }

        /* --- æ·±è‰²æ¨¡å¼ä¸»é¡Œ --- */
        [data-theme="dark"] {
            --primary: #60a5fa; --primary-hover: #3b82f6; --primary-light: #1e3a8a;
            --success: #34d399; --success-hover: #10b981; --success-light: #064e3b;
            --danger: #f87171; --danger-hover: #ef4444; --danger-light: #450a0a;
            --warning: #fbbf24; --warning-hover: #f59e0b;
            --info: #818cf8; --info-hover: #6366f1;
            
            --bg-body: #0f172a; 
            --bg-card: #1e293b;
            --bg-input: #334155;
            
            --text-main: #f1f5f9; 
            --text-secondary: #cbd5e1;
            --border: #475569;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.5);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.5), 0 2px 4px -2px rgb(0 0 0 / 0.5);
        }
        
        [data-theme="dark"] .btn { color: #f8fafc !important; border-color: #64748b; }
        [data-theme="dark"] .btn-primary { background-color: var(--primary); color: white !important; border-color: var(--primary); }
        [data-theme="dark"] .btn-secondary { background-color: transparent; color: #f8fafc !important; }

        /* --- OPUS é¢¨æ ¼ä¸»é¡Œ (ä¿®æ­£: background: ç¢ºæ”¯æ´æ¼¸å±¤) --- */
        [data-theme="opus"] {
            --primary: #f97316; --primary-hover: #ea580c; --primary-light: rgba(249, 115, 22, 0.15);
            --success: #fbbf24; --success-hover: #f59e0b; --success-light: rgba(251, 191, 36, 0.15); 
            --danger: #ff2a2a; --danger-hover: #ff0000; --danger-light: rgba(255, 42, 42, 0.1);
            --warning: #ffffff; --warning-hover: #e5e7eb;
            --info: #00d2ff; --info-hover: #3a7bd5;
            
            /* æ·±è‰²æ¼¸å±¤èƒŒæ™¯ */
            --bg-body: radial-gradient(circle at center, #1a2236 0%, #05070a 100%);
            --bg-card: linear-gradient(180deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 33, 0.98) 100%);
            --bg-input: rgba(30, 41, 59, 0.4);
            
            --text-main: #e0f2fe;  /* å†°ç™½ */
            --text-secondary: #94a3b8; /* éœ§ç° */
            --border: rgba(56, 189, 248, 0.2);
            
            --radius-sm: 0px; 
            --radius-md: 0px;
            
            --shadow-sm: 0 0 0 1px rgba(56, 189, 248, 0.1);
            --shadow-md: 0 0 20px rgba(0, 210, 255, 0.05);
            
            --font-heading: 'Orbitron', 'Noto Sans TC', sans-serif;
            --anim-speed: 0.5s;
        }

        /* æ¨™é¡Œå¼·åˆ¶ç½®ä¸­èˆ‡ç™½è‰²æ–‡å­— (OPUS ä¿®æ­£ç‰ˆ) */
        [data-theme="opus"] h1, 
        [data-theme="opus"] h2, 
        [data-theme="opus"] h3, 
        [data-theme="opus"] h4, 
        [data-theme="opus"] .team-info h4, 
        [data-theme="opus"] .data-table th, 
        [data-theme="opus"] .input-group label,
        [data-theme="opus"] #student-form-panel h4 {
            color: #fff !important;
            text-align: center !important; /* å¼·åˆ¶ç½®ä¸­ */
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        /* ç¢ºä¿å·¦å³çµæ§‹çš„æ¨™é¡Œä¹Ÿç½®ä¸­ (å¦‚å´é‚Šæ¬„) */
        [data-theme="opus"] .sidebar h3, 
        [data-theme="opus"] .admin-tabs {
            text-align: center !important;
        }
        
        [data-theme="opus"] .data-table th { text-align: left !important; }
        [data-theme="opus"] .data-table td { text-align: left !important; }
        
        [data-theme="opus"] h1 { 
            letter-spacing: 5px; 
            font-size: 2em; 
            color: var(--info) !important; 
            border-bottom: 1px solid var(--border); 
            display: inline-block; 
            padding-bottom: 15px; 
            margin-bottom: 40px; 
            position: relative;
            width: 100%; /* ç¢ºä¿å¯¬åº¦æ»¿ç‰ˆä»¥ä¾¿ç½®ä¸­ç”Ÿæ•ˆ */
        }
        [data-theme="opus"] h1::after {
            content: ''; position: absolute; left: 50%; bottom: -1px; width: 20%; height: 2px; background: var(--primary); transform: translateX(-50%);
        }
        
        /* é€šç”¨æ¨™é¡Œç½®ä¸­ */
        .card h2, .card h3, .modal-content h3, #admin-welcome-panel h3 {
            text-align: center;
        }

        /* --- CRT æƒæç·šèˆ‡è¦–è¦ºæ•ˆæœ (OPUS å°ˆå±¬) --- */
        [data-theme="opus"] body::before {
            /* èƒŒæ™¯ç¶²æ ¼ - åœ¨æœ€ä¸‹å±¤ */
            content: ''; position: fixed; top: 0; left: 0; width: 200vw; height: 200vh;
            background-image: 
                linear-gradient(var(--border) 1px, transparent 1px),
                linear-gradient(90deg, var(--border) 1px, transparent 1px);
            background-size: 60px 60px;
            background-position: center;
            transform: perspective(500px) rotateX(60deg) translateY(-150px) translateZ(-200px);
            opacity: 0.05;
            z-index: -2;
            animation: gridMove 30s linear infinite;
        }

        [data-theme="opus"] body::after {
            /* CRT æƒæç·šè¦†è“‹å±¤ - æœ€ä¸Šå±¤ä½†é»æ“Šç©¿é€ */
            content: " "; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            z-index: 9999;
            pointer-events: none; 
            opacity: 0.3;
            box-shadow: 0 0 100px rgba(0,0,0,0.9) inset; /* CRTé‚Šè§’æš—è§’ */
        }

        [data-theme="opus"] .card {
            animation: subtleFlicker 4s infinite;
        }

        @keyframes gridMove { 0% { transform: perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px); } 100% { transform: perspective(500px) rotateX(60deg) translateY(60px) translateZ(-200px); } }
        @keyframes subtleFlicker { 
            0% { opacity: 0.98; }
            3% { opacity: 0.94; }
            6% { opacity: 0.99; }
            9% { opacity: 1; }
            89% { opacity: 1; }
            93% { opacity: 0.96; }
            96% { opacity: 1; }
            100% { opacity: 0.98; }
        }

        /* --- åŸºç¤æ¨£å¼ --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Noto Sans TC', sans-serif; }
        
        /* ä¿®æ­£ï¼šå°‡ background-color æ”¹ç‚º background ä»¥æ”¯æ´æ¼¸å±¤ */
        body { 
            background: var(--bg-body); 
            color: var(--text-main); line-height: 1.6; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 0; overflow-x: hidden; transition: background-color 0.6s ease, color 0.6s ease; position: relative; 
        }
        
        #app-container { max-width: 1440px; width: 100%; padding: 20px; flex: 1; display: flex; flex-direction: column; position: relative; z-index: 1; }

        [data-theme="opus"] .card {
            border: 1px solid var(--border); 
            transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s;
        }
        [data-theme="opus"] .card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 1px;
            background: linear-gradient(90deg, transparent, var(--info), transparent);
            opacity: 0.5;
        }
        /* å¡ç‰‡å››è§’æ¥µç°¡æ¨™ç¤º */
        [data-theme="opus"] .card::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to right, var(--info) 1px, transparent 1px) 0 0, linear-gradient(to bottom, var(--info) 1px, transparent 1px) 0 0, linear-gradient(to left, var(--info) 1px, transparent 1px) 100% 0, linear-gradient(to top, var(--info) 1px, transparent 1px) 100% 100%;
            background-size: 10px 10px;
            background-repeat: no-repeat;
            opacity: 0.3;
            pointer-events: none;
            transition: opacity 0.4s;
        }
        
        /* ä¿®æ­£æ‡¸æµ®å‹•ç•«ï¼šå¹…åº¦è®Šå° (-1px) */
        [data-theme="opus"] .card:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.15);
            border-color: var(--info); 
        }
        [data-theme="opus"] .card:hover::after { opacity: 0.8; }

        .card { background-color: var(--bg-card); border-radius: var(--radius-md); box-shadow: var(--shadow-sm); padding: 30px; margin-bottom: 0; border: 1px solid transparent; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); width: 100%; backdrop-filter: blur(10px); position: relative; overflow: hidden; }
        .card:hover { box-shadow: var(--shadow-md); border-color: var(--border); transform: translateY(-1px); }

        #result-container { display: flex; flex-direction: column; align-items: center; }
        #result-container .card { width: auto; margin-bottom: 40px; }

        /* é¢æ¿å‹•ç•«é€²å…¥ */
        .animate-panel-enter {
            animation: slideInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        .input-group { margin-bottom: 16px; position: relative; width: 100%; }
        .input-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9em; color: var(--text-secondary); }
        
        .input-group textarea, .input-group input, .input-group select {
            width: 100%; padding: 10px 14px; 
            border: 1px solid var(--border); border-radius: var(--radius-sm); 
            font-size: 1em; background: var(--bg-input); color: var(--text-main);
            transition: all 0.3s ease;
        }

        /* OPUS è¼¸å…¥æ¡†æ¥µç°¡æ¥µè‡´ */
        [data-theme="opus"] .input-group input, [data-theme="opus"] .input-group textarea, [data-theme="opus"] .input-group select {
            background: rgba(10, 15, 20, 0.8);
            border: 1px solid transparent;
            border-bottom: 1px solid rgba(56, 189, 248, 0.3);
        }
        [data-theme="opus"] .input-group input:focus, [data-theme="opus"] .input-group textarea:focus, [data-theme="opus"] .input-group select:focus {
            outline: none;
            background: rgba(20, 30, 40, 0.9);
            border-bottom: 1px solid var(--info);
            box-shadow: 0 10px 20px -10px rgba(0, 210, 255, 0.2);
        }
        
        .batch-inputs-wrapper { display: flex; gap: 10px; width: 100%; align-items: center; }
        .batch-inputs-wrapper input { width: 50%; }

        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 8px 16px; border: none; border-radius: var(--radius-sm); font-size: 0.9em; font-weight: 500; cursor: pointer; transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); text-decoration: none; line-height: 1.5; position: relative; overflow: hidden; outline: none; -webkit-tap-highlight-color: transparent;}
        
        /* æŒ‰éˆ•æŒ‰ä¸‹å‹•ç•« */
        .btn:active {
            transform: scale(0.95);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        /* OPUS æŒ‰éˆ•é¢¨æ ¼ */
        [data-theme="opus"] .btn { 
            background: transparent; border: 1px solid var(--border); color: var(--info) !important; 
            letter-spacing: 1px; text-transform: uppercase; font-size: 0.8em; font-weight: 600; font-family: 'Orbitron', sans-serif;
            position: relative;
            box-shadow: 0 0 5px transparent;
        }
        [data-theme="opus"] .btn:hover { 
            background: rgba(0, 210, 255, 0.1); 
            color: #fff !important;
            border-color: var(--info); 
            box-shadow: 0 0 15px rgba(0, 210, 255, 0.3);
            transform: translateY(-1px);
        }
        [data-theme="opus"] .btn:active {
            transform: scale(0.97);
            background: rgba(0, 210, 255, 0.2);
        }

        /* OPUS åˆªé™¤æŒ‰éˆ• */
        [data-theme="opus"] .btn-danger {
            border-color: #ff5555; color: #ff5555 !important;
        }
        [data-theme="opus"] .btn-danger:hover {
            background: rgba(255, 85, 85, 0.1);
            color: #ff5555 !important; 
            box-shadow: 0 0 15px rgba(255, 85, 85, 0.4);
            animation: dangerGlitch 0.3s cubic-bezier(.25, .46, .45, .94) both infinite;
        }
        @keyframes dangerGlitch { 0% { transform: translate(0); } 20% { transform: translate(-2px, 1px); } 40% { transform: translate(-2px, -1px); } 60% { transform: translate(2px, 1px); } 80% { transform: translate(2px, -1px); } 100% { transform: translate(0); } }

        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-secondary:hover { background-color: var(--bg-body); border-color: #cbd5e1; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-success:hover { background-color: var(--success-hover); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover { background-color: var(--danger-hover); }
        .btn-info { background-color: var(--info); color: white; }
        .btn-info:hover { background-color: var(--info-hover); }

        .btn-small { padding: 5px 10px; font-size: 0.85em; border-radius: 4px; }
        .button-group, .action-btn-group { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        
        .hidden { display: none !important; }

        .admin-tabs { display: flex; background: var(--bg-body); padding: 4px; border-radius: var(--radius-sm); width: fit-content; border: 1px solid var(--border); }
        .tab-btn { padding: 8px 20px; cursor: pointer; border: none; background: transparent; font-size: 0.9em; font-weight: 600; color: var(--text-secondary); border-radius: 4px; transition: all 0.3s; }
        .tab-btn:hover { color: var(--text-main); }
        .tab-btn.active { background: var(--bg-card); color: var(--primary); box-shadow: var(--shadow-sm); font-weight: 600; border: 1px solid var(--border); }

        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; overflow: hidden; border-radius: var(--radius-sm); }
        .data-table th { background-color: rgba(248, 250, 252, 0.1); color: var(--text-secondary); font-weight: 600; font-size: 0.9em; text-align: left; padding: 12px 16px; border-bottom: 1px solid var(--border); }
        .data-table td { padding: 12px 16px; border-bottom: 1px solid var(--border); color: var(--text-main); font-size: 0.95em; }
        .data-table tbody tr:last-child td { border-bottom: none; }
        .data-table tbody tr:hover { background-color: rgba(248, 250, 252, 0.05); }

        .badge { display: inline-block; padding: 2px 8px; border-radius: 9999px; font-size: 0.8em; font-weight: 600; }
        .status-å·²èªè­‰ { background-color: var(--success-light); color: var(--success); }
        .status-å¯©æ ¸ä¸­, .status-èªè­‰ä¸­ { background-color: var(--primary-light); color: var(--primary); }
        .status-èªè­‰å¤±æ•— { background-color: var(--danger-light); color: var(--danger); }
        .status-æœªå®Œæˆ { background-color: rgba(241, 245, 249, 0.1); color: var(--text-secondary); border: 1px solid var(--border); }
        .team-badge { background-color: var(--info); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; margin-right: 8px; }
        .type-badge-group { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; margin-right: 4px; }
        .type-personal { background-color: #e0e7ff; color: #4338ca; }
        .type-team { background-color: #dbeafe; color: #1e40af; }

        [data-theme="dark"] .type-personal, [data-theme="opus"] .type-personal { background-color: #312e81; color: #a5b4fc; border: 1px solid rgba(165, 180, 252, 0.3); }
        [data-theme="dark"] .type-team, [data-theme="opus"] .type-team { background-color: #1e3a8a; color: #93c5fd; border: 1px solid rgba(147, 197, 253, 0.3); }

        .admin-layout { display: grid; grid-template-columns: 480px 1fr; gap: 24px; align-items: start; }
        @media (max-width: 1024px) { .admin-layout { grid-template-columns: 1fr; } }

        .sidebar { background: var(--bg-card); padding: 24px; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); min-height: 400px; border: 1px solid var(--border); }
        .list-container { background: var(--bg-card); padding: 24px; border-radius: var(--radius-md); box-shadow: var(--shadow-sm); min-height: 500px; border: 1px solid var(--border); }

        .list-search { width: 100%; margin-bottom: 10px; padding: 8px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); background-color: var(--bg-input); color: var(--text-main); font-size: 0.9em; }
        .list-search::placeholder { color: #94a3b8; }

        .stat-box { background: var(--primary-light); padding: 15px; border-radius: var(--radius-sm); margin-bottom: 10px; text-align: center; border: 1px solid var(--border); }
        .stat-num { font-size: 1.8em; font-weight: 700; color: var(--primary); display: block; }
        .stat-label { font-size: 0.85em; color: var(--text-main); }

        /* Modal & Progress Bar */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: var(--bg-overlay); backdrop-filter: blur(8px); align-items: center; justify-content: center; }
        .modal-content { background-color: var(--bg-card); padding: 30px; border-radius: var(--radius-md); width: 90%; max-width: 550px; box-shadow: var(--shadow-md); position: relative; animation: modalFadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); max-height: 90vh; display: flex; flex-direction: column; border: 1px solid var(--border); }
        .modal-body { overflow-y: auto; margin: 20px 0; padding: 0; border: none; flex-grow: 1; width: 100%; min-height: 100px; }
        .modal-scroll { overflow-y: auto; padding-right: 5px; }
        .close-modal { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; color: #94a3b8; transition: 0.2s; }
        .close-modal:hover { color: var(--text-main); }

        /* é€²åº¦æ¢å‹•ç•«æ¨£å¼ */
        .progress-container { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; width: 100%; padding: 20px; }
        .progress-bar-bg { width: 100%; height: 4px; background: var(--bg-input); border-radius: 2px; overflow: hidden; position: relative; margin-bottom: 10px; }
        .progress-bar-fill { height: 100%; background: var(--info); width: 0%; box-shadow: 0 0 10px var(--info); transition: width 0.1s linear; }
        .progress-text { font-family: 'Orbitron', 'Source Code Pro', monospace; font-size: 0.8em; color: var(--text-secondary); letter-spacing: 1px; }

        .comment { padding: 14px; border-radius: var(--radius-sm); font-size: 0.95em; margin-bottom: 10px; animation: fadeInUp 0.3s ease-out; line-height: 1.5; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .comment-student { background-color: var(--bg-card); border: 1px solid var(--border); align-self: flex-start; max-width: 85%; margin-right: auto; }
        .comment-teacher { background-color: var(--primary-light); border: 1px solid var(--primary); color: #1e40af; align-self: flex-end; max-width: 85%; text-align: left; margin-left: auto; }
        [data-theme="dark"] .comment-teacher, [data-theme="opus"] .comment-teacher { background-color: rgba(59, 130, 246, 0.2); color: #93c5fd; border-color: #3b82f6; }

        .comment-recalled { background: repeating-linear-gradient(45deg, var(--bg-input), var(--bg-input) 10px, var(--bg-card) 10px, var(--bg-card) 20px); border: 1px dashed var(--border); text-align: center; font-style: italic; color: var(--text-secondary); width: 100%; max-width: 100%; align-self: center; }

        .task-admin-container { margin-bottom:10px; max-height: 250px; overflow-y:auto; border:1px solid var(--border); border-radius:var(--radius-sm); }
        .admin-table-inner { width:100%; border-collapse: collapse; font-size: 0.9em; }
        .admin-table-inner thead { background:#f8fafc; position:sticky; top:0; z-index:10; }
        .admin-table-inner th { padding:8px 6px; font-weight:600; font-size:0.8em; color:var(--text-secondary); border-bottom:1px solid var(--border); white-space: nowrap;}
        .admin-table-inner td { padding:8px 6px; border-bottom:1px solid var(--border); vertical-align: middle; }
        [data-theme="dark"] .admin-table-inner thead, [data-theme="opus"] .admin-table-inner thead { background: rgba(255,255,255,0.05); }

        .preview-box { background: var(--bg-card); color: var(--text-main); padding: 15px; border-radius: var(--radius-sm); font-family: monospace; font-size: 0.9em; white-space: pre-wrap; margin-top: 10px; border: 1px solid var(--border); }
        .rule-help { background:var(--primary-light); padding:15px; font-size:0.85em; border:1px solid var(--border); border-radius:var(--radius-sm); margin-bottom:15px; color:var(--text-main);}
        .rule-help code { background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:4px; font-family: monospace; color: inherit;}

        .team-list-item { display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid var(--border); transition: background 0.2s; }
        .team-list-item:last-child { border-bottom: none; }
        .team-list-item:hover { background-color: rgba(248, 250, 252, 0.05); }

        [data-theme="opus"] .team-list-item { border-bottom: 1px solid rgba(56, 189, 248, 0.2); }
        [data-theme="opus"] .team-list-item:hover { background-color: rgba(56, 189, 248, 0.05); }

        .batch-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .batch-table th { background: rgba(248, 250, 252, 0.1); color: var(--text-secondary); font-weight: 600; padding: 10px; text-align: left; border-bottom: 2px solid var(--border); }
        .batch-table td { padding: 8px; border-bottom: 1px solid var(--border); cursor: text; }
        .batch-table input { width: 100%; border: 1px solid transparent; background: transparent; padding: 6px; font-size: inherit; border-radius: 4px; transition: 0.2s; cursor: text; color: inherit;}
        .batch-table input:hover { border-color: #cbd5e1; background: var(--bg-body); }
        .batch-table input:focus { border-color: var(--primary); background: var(--bg-body); outline: none; cursor: text;}
        
        #toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { padding: 12px 20px; background: var(--bg-card); border-radius: var(--radius-sm); box-shadow: var(--shadow-md); animation: slideInUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); min-width: 280px; display: flex; align-items: center; font-weight: 500; border-left: 4px solid var(--primary); pointer-events: auto; color: var(--text-main); pointer-events: auto; backdrop-filter: blur(5px); }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.warning { border-left-color: var(--warning); }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-overlay); z-index: 20000; display: none; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(10px); transition: opacity 0.5s ease; }
        
        /* --- OPUS Loader V5ï¼šç²¾ç·»åæ‡‰å †æ ¸å¿ƒ --- */
        .planet-probe-spacer {
            display: none; 
            width: 0; height: 0;
            overflow: hidden;
        }
        body[data-theme="opus"] .spinner { display: none; } 
        body[data-theme="opus"] .planet-probe-spacer { 
            display: flex; 
            position: relative; width: 80px; height: 80px;
            align-items: center; justify-content: center;
        }

        /* æ ¸å¿ƒå…‰é» */
        .reactor-core {
            width: 20px; height: 20px;
            background-color: var(--info);
            border-radius: 50%;
            box-shadow: 0 0 15px var(--info), 0 0 30px var(--info);
            position: absolute;
            animation: pulseCore 2s infinite ease-in-out;
            z-index: 10;
        }

        /* å¤–å±¤æ—‹è½‰å„€è¡¨ç’° */
        .reactor-outer {
            width: 100%; height: 100%;
            border: 2px solid rgba(0, 210, 255, 0.1);
            border-top-color: var(--info);
            border-radius: 50%;
            position: absolute;
            animation: spin 1.5s linear infinite;
        }

        /* å…§å±¤åå‘æ—‹è½‰ç’° */
        .reactor-middle {
            width: 60%; height: 60%;
            border: 1px dashed rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            position: absolute;
            animation: spinCCW 3s linear infinite;
        }

        @keyframes pulseCore { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.3); opacity: 1; } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes spinCCW { 100% { transform: rotate(-360deg); } }

        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }

        @keyframes slideInUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        #confirm-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10001; display: none; background: var(--bg-overlay); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .confirm-box { background: var(--bg-card); padding: 32px; border-radius: var(--radius-md); text-align: center; min-width: 320px; box-shadow: var(--shadow-md); color: var(--text-main); }

        #theme-toggle-btn {
            position: fixed; bottom: 24px; right: 24px;
            width: 48px; height: 48px; border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-card); color: var(--text-main);
            font-size: 20px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: var(--shadow-md); z-index: 5000;
            transition: all 0.3s ease;
        }
        #theme-toggle-btn:hover { transform: rotate(90deg) scale(1.1); background: var(--primary-light); color: var(--primary); }
        
        body[data-theme="opus"] #theme-toggle-btn {
             box-shadow: 0 0 10px rgba(0, 210, 255, 0.3); border-color: rgba(0, 210, 255, 0.3); color: var(--info);
             background: rgba(10, 15, 20, 0.8);
        }
        body[data-theme="opus"] #theme-toggle-btn:hover { background: rgba(0, 210, 255, 0.1); color: #fff; border-color: var(--info); }

        /* --- ç™»å‡ºå‹•ç•«å±¤ --- */
        #logout-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 30000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.5s ease;
        }
        
        /* OPUS ç‰¹é¢¨æ ¼æ‰“å­—æ©Ÿ */
        [data-theme="opus"] .typewriter-text {
            color: var(--info); 
            font-family: 'Orbitron', monospace; 
            font-size: 2.5em; 
            font-weight: 700;
            position: relative; 
            min-height: 1.5em;
            text-shadow: 0 0 15px var(--info), 0 0 30px var(--primary);
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        [data-theme="opus"] .cursor {
            display: inline-block; width: 15px; height: 1.2em; background-color: var(--info);
            margin-left: 5px; vertical-align: middle;
            animation: blinkOpus 1s infinite;
            box-shadow: 0 0 10px var(--info);
        }
        @keyframes blinkOpus { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* é è¨­æ‰“å­—æ©Ÿæ¨£å¼ (éOPUS) */
        .typewriter-text {
            color: #fff; 
            font-family: sans-serif; 
            font-size: 2em;
            font-weight: 600;
        }
        .cursor {
            display: inline-block; width: 3px; height: 1.5em; background-color: #fff;
            margin-left: 5px; vertical-align: middle;
            animation: blink 0.8s infinite;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

    </style>
</head>
<body>

    <!-- å…¨å±€ Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="planet-probe-spacer">
            <div class="reactor-outer"></div>
            <div class="reactor-middle"></div>
            <div class="reactor-core"></div>
        </div>
        <p style="margin-top:20px; color:var(--text-secondary); font-weight:600; letter-spacing: 1px;">SYSTEM SYNCHRONIZING...</p>
    </div>

    <!-- ç™»å‡ºå‹•ç•« Overlay -->
    <div id="logout-overlay">
        <div class="typewriter-text"></div>
    </div>

    <button id="theme-toggle-btn" title="åˆ‡æ›ä¸»é¡Œ">ğŸ¨</button>

    <div id="app-container">
        <h1>æ´»å‹•/æˆç¸¾èªè­‰æŸ¥è©¢ç³»çµ±</h1>
        
        <div id="toast-container"></div>
        <div id="confirm-container"></div>

        <!-- 1. å­¸ç”Ÿç™»å…¥ -->
        <div id="login-container" class="card animate-panel-enter" style="max-width: 480px; margin: 40px auto; padding: 40px;">
            <h2 style="text-align:center; margin-bottom:30px;">æˆç¸¾æŸ¥è©¢ç™»å…¥</h2>
            <form id="login-form">
                <div class="input-group">
                    <label>å­¸æ ¡åç¨±</label>
                    <input type="text" id="school" value="æ°¸é–é«˜å·¥" required>
                </div>
                <div class="input-group">
                    <label>ç­ç´š</label>
                    <input type="text" id="class" value="è³‡è¨ŠäºŒ" required>
                </div>
                <div class="input-group">
                    <label>å­¸è™Ÿ</label>
                    <input type="text" id="account" placeholder="è«‹è¼¸å…¥å­¸è™Ÿ" required>
                </div>
                <div class="input-group">
                    <label>å¯†ç¢¼ (ç™»å…¥ç”¨ï¼Œç„¡æ³•ä¿®æ”¹)</label>
                    <input type="password" id="password" placeholder="è¼¸å…¥æŸ¥è©¢å¯†ç¢¼" required>
                </div>
                <div class="button-group wide" style="margin-top:30px; flex-direction:column;">
                    <button type="submit" class="btn btn-primary" style="width:100%; padding:12px 0;">ç™»å…¥æŸ¥è©¢</button>
                    <button type="button" class="btn btn-secondary" style="width:100%;" onclick="window.showAdminLogin()">æˆ‘æ˜¯æ•™å¸«</button>
                </div>
                <div id="login-error" class="hidden" style="color: var(--danger); margin-top: 20px; font-weight: 600; text-align: center; padding: 10px; background: var(--danger-light); border-radius: var(--radius-sm);"></div>
            </form>
        </div>

        <!-- 2. æ•™å¸«ç™»å…¥ -->
        <div id="admin-login-container" class="card hidden animate-panel-enter" style="max-width: 400px; margin: 40px auto; padding: 40px;">
            <h2 style="text-align:center; margin-bottom:30px;">æ•™å¸«ç®¡ç†å“¡ç™»å…¥</h2>
            <form id="admin-login-form">
                <div class="input-group">
                    <label>ç®¡ç†å¯†ç¢¼</label>
                    <input type="password" id="admin-password" required>
                </div>
                <div class="button-group wide" style="margin-top:30px; flex-direction:column;">
                    <button type="submit" class="btn btn-primary" style="width:100%; padding:12px 0;">ç™»å…¥ç®¡ç†</button>
                    <button type="button" class="btn btn-secondary" style="width:100%;" onclick="window.showStudentLogin()">è¿”å›</button>
                </div>
                <div id="admin-login-error" class="hidden" style="color: var(--danger); margin-top: 20px; font-weight: 600; text-align: center; padding: 10px; background: var(--danger-light); border-radius: var(--radius-sm);"></div>
            </form>
        </div>

        <!-- 3. å­¸ç”Ÿçµæœé é¢ -->
        <div id="result-container" class="hidden">
            <div class="card animate-panel-enter" style="max-width: 800px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; padding-bottom:20px; border-bottom:1px solid var(--border);">
                    <h3>å­¸ç”ŸåŸºæœ¬è³‡æ–™</h3>
                    <button class="btn btn-secondary" onclick="window.logout()">ç™»å‡º</button>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <p><label style="color:var(--text-secondary); font-size:0.9em;">å­¸è™Ÿï¼š</label><span id="result-account"></span></p>
                    <p><label style="color:var(--text-secondary); font-size:0.9em;">å§“åï¼š</label><span id="result-name"></span></p>
                    <p><label style="color:var(--text-secondary); font-size:0.9em;">å­¸æ ¡ï¼š</label><span id="result-school"></span></p>
                    <p><label style="color:var(--text-secondary); font-size:0.9em;">ç­ç´šï¼š</label><span id="result-class"></span></p>
                    <p><label style="color:var(--text-secondary); font-size:0.9em;">é›»å­éƒµä»¶ï¼š</label><span id="result-email"></span></p>
                </div>
            </div>
            
            <div class="card animate-panel-enter" style="max-width: 1000px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; padding-bottom:15px; border-bottom:1px solid var(--border);">
                    <h2>å­¸æœŸæˆç¸¾é …ç›®</h2>
                    <button class="btn btn-info" onclick="window.openTeamJoinModal()">æŸ¥çœ‹/åŠ å…¥åœ˜éšŠæ´»å‹•</button>
                </div>
                <table id="tasks-table-student" class="data-table">
                    <thead><tr><th>é …ç›®åç¨± (é¡å‹)</th><th>ç‹€æ…‹</th><th style="text-align:right;">æ“ä½œ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- 4. æ•™å¸«ç®¡ç†ä»‹é¢ -->
        <div id="admin-container" class="hidden">
            <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; flex-wrap:wrap; gap:15px;">
                <div class="admin-tabs">
                    <button class="tab-btn active" onclick="window.switchAdminTab('student')">å­¸ç”Ÿè³‡æ–™ç®¡ç†</button>
                    <button class="tab-btn" onclick="window.switchAdminTab('team')">åœ˜éšŠæ´»å‹•</button>
                    <button class="tab-btn" onclick="window.switchAdminTab('overview')">èªè­‰ç¸½è¦½</button>
                    <button class="tab-btn" onclick="window.switchAdminTab('batch')">æ‰¹é‡æ–°å¢</button>
                </div>
                <div class="action-btn-group">
                    <button class="btn btn-secondary btn-small" onclick="window.adminLogout()">ç™»å‡ºæ•™å¸«</button>
                    <button class="btn btn-success btn-small" onclick="window.exportData()">åŒ¯å‡ºæœ¬åœ°å‚™ä»½</button>
                </div>
            </header>
            
            <div class="admin-layout">
                <div class="sidebar">
                    <div id="tab-student-action">
                        <div id="admin-welcome-panel" class="animate-panel-enter">
                            <h3>ç®¡ç†é¸å–®</h3>
                            <div style="display:flex; flex-direction:column; gap:12px; margin-top:16px;">
                                <button class="btn btn-warning" style="width:100%; justify-content: flex-start;" onclick="window.showStudentForm('new')">â• æ–°å¢å–®ä¸€å­¸ç”Ÿ</button>
                                <button class="btn btn-info" style="width:100%; justify-content: flex-start;" onclick="window.openTeamModal(false)">â• æ–°å¢åœ˜éšŠæ´»å‹•</button>
                            </div>
                            <div style="margin-top:30px; padding:20px; background:var(--bg-body); border-radius:var(--radius-sm); border:1px solid var(--border);">
                                <h4 style="margin-bottom:10px; font-size:0.9em; color:var(--text-secondary);">Google Sheet é€£ç·šç‹€æ…‹</h4>
                                <div id="sync-status" style="font-size:0.85em; color:var(--success); font-weight:600;">æª¢æŸ¥ä¸­...</div>
                            </div>
                        </div>

                        <div id="student-form-panel" class="hidden animate-panel-enter">
                            <h3>ç·¨è¼¯/æ–°å¢å­¸ç”Ÿ</h3>
                            <form id="student-form" style="margin-top:20px;">
                                <div class="input-group">
                                    <label>å­¸è™Ÿ</label>
                                    <input type="text" id="admin-account" required>
                                </div>
                                <div class="input-group">
                                    <label>å§“å</label>
                                    <input type="text" id="admin-name" required>
                                </div>
                                <div class="input-group">
                                    <label>å­¸æ ¡</label>
                                    <input type="text" id="admin-school" value="æ°¸é–é«˜å·¥" required>
                                </div>
                                <div class="input-group">
                                    <label>ç­ç´š</label>
                                    <input type="text" id="admin-class" value="è³‡è¨ŠäºŒ" required>
                                </div>
                                <div class="input-group">
                                    <label>Email</label>
                                    <input type="email" id="admin-email">
                                </div>
                                
                                <h4 style="margin:20px 0 10px 0; color:var(--text-main); font-size:0.95em;">å€‹äººé …ç›®åˆ—è¡¨</h4>
                                <div class="task-admin-container">
                                    <table id="tasks-table-admin" class="admin-table-inner">
                                        <thead>
                                            <tr>
                                                <th style="text-align:left; width: 40%;">åç¨±</th>
                                                <th style="text-align:left; width: 20%;">ç‹€æ…‹</th>
                                                <th style="text-align:center; width: 20%;">ç•™è¨€</th>
                                                <th style="text-align:center; width: 5%;"></th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                                <button type="button" class="btn btn-secondary btn-small" style="margin-top:5px;" onclick="window.addTaskRow()">+ æ–°å¢å€‹äººé …ç›®</button>
                                
                                <div class="action-btn-group" style="margin-top:24px; border-top:1px solid var(--border); padding-top:16px;">
                                    <button type="submit" id="submit-student-btn" class="btn btn-primary">å„²å­˜è®Šæ›´</button>
                                    <button type="button" id="switch-to-new-student-btn" class="btn btn-success hidden" onclick="window.switchToNewStudentMode(true)">åˆ‡æ›è‡³æ–°å¢</button>
                                    <button type="button" class="btn btn-secondary" onclick="window.showWelcomePanel()">å–æ¶ˆ</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div id="tab-team-action" class="hidden animate-panel-enter">
                        <h3>åœ˜éšŠæ´»å‹•æ“ä½œ</h3>
                        <button class="btn btn-success" style="width:100%; margin-bottom:20px;" onclick="window.openTeamModal(false)">å»ºç«‹æ–°åœ˜éšŠæ´»å‹•</button>
                        
                        <div style="background:var(--primary-light); padding:20px; border-radius:var(--radius-sm); border:1px solid var(--border); color:var(--primary);">
                            <h4 style="margin-bottom:10px; font-size:0.95em;">åŠŸèƒ½èªªæ˜</h4>
                            <ul style="padding-left:20px; line-height: 1.5; font-size:0.9em;">
                                <li>åœ˜éšŠæ´»å‹•å…è¨±å¤šä½å­¸ç”Ÿå…±åŒåƒèˆ‡åŒä¸€å€‹ä»»å‹™ã€‚</li>
                                <li>é–‹æ”¾åŠ å…¥ï¼šå­¸ç”Ÿå¯åœ¨é¦–é è‡ªè¡Œé»æ“ŠåŠ å…¥ã€‚</li>
                                <li>é™åˆ¶åŠ å…¥ï¼šåƒ…èƒ½ç”±æ•™å¸«åœ¨æ­¤æ‰‹å‹•è¼¸å…¥å­¸è™Ÿæ–°å¢æˆå“¡ã€‚</li>
                            </ul>
                        </div>
                    </div>

                    <div id="tab-overview-action" class="hidden animate-panel-enter">
                        <h3>èªè­‰çµ±è¨ˆèˆ‡éæ¿¾</h3>
                        <div style="margin-top:20px;">
                            <div class="stat-box">
                                <span class="stat-num" id="filtered-count">0</span>
                                <span class="stat-label">ç¬¦åˆç¯©é¸æ¢ä»¶é …ç›®</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div class="stat-box" style="background:var(--success-light); border-color: var(--border);">
                                    <span class="stat-num" style="color:var(--success);" id="filtered-certified">0</span>
                                    <span class="stat-label">å·²èªè­‰</span>
                                </div>
                                <div class="stat-box" style="background:var(--danger-light); border-color: var(--border);">
                                    <span class="stat-num" style="color:var(--danger);" id="filtered-failed">0</span>
                                    <span class="stat-label">å¾…è™•ç†/å¤±æ•—</span>
                                </div>
                            </div>
                            
                            <div style="margin-top:20px; padding:15px; background:var(--bg-card); border-radius:var(--radius-sm); border:1px solid var(--border);">
                                <h4 style="font-size:0.9em; margin-bottom:10px; color:var(--text-main);">ç¯©é¸å™¨</h4>
                                
                                <div class="input-group">
                                    <label>é¡å‹</label>
                                    <select id="overview-type-filter" class="list-search" onchange="renderGlobalList()">
                                        <option value="all">å…¨éƒ¨ (å€‹äºº + åœ˜éšŠ)</option>
                                        <option value="personal">åƒ…é¡¯ç¤º å€‹äººé …ç›®</option>
                                        <option value="team">åƒ…é¡¯ç¤º åœ˜éšŠæ´»å‹•</option>
                                    </select>
                                </div>

                                <div class="input-group">
                                    <label>ç‹€æ…‹</label>
                                    <select id="overview-status-filter" class="list-search" onchange="renderGlobalList()">
                                        <option value="all">å…¨éƒ¨ç‹€æ…‹</option>
                                        <option value="todo">å¾…è™•ç† (æœªå®Œæˆ / å¤±æ•— / å¯©æ ¸ä¸­)</option>
                                        <option value="certified">å·²èªè­‰</option>
                                        <option value="failed">èªè­‰å¤±æ•—</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-batch-action" class="hidden animate-panel-enter">
                        <h3>å¿«é€Ÿæ‰¹æ¬¡æ–°å¢</h3>
                        <div style="background:var(--bg-input); padding:20px; border-radius:var(--radius-sm); border:1px solid var(--border); color:var(--text-secondary); margin-bottom:20px; font-size:0.9em;">
                            æ­¤åŠŸèƒ½ä½¿ç”¨è¦å‰‡ç”Ÿæˆå™¨è‡ªå‹•ç”¢ç”Ÿå­¸è™Ÿèˆ‡å¸³è™Ÿï¼Œé©ç”¨æ–¼å¤§é‡å»ºç«‹ã€‚
                        </div>
                        <button class="btn btn-primary" style="width:100%;" onclick="window.openBatchModal()">é–‹å•Ÿè¨­å®šè¦–çª—</button>
                    </div>

                </div>

                <div class="list-container animate-panel-enter">
                    <h3 id="list-title" style="margin-bottom:16px;">å­¸ç”Ÿåˆ—è¡¨</h3>
                    
                    <div id="overview-search-container" class="hidden">
                        <label style="font-size:0.85em; font-weight:600; color:var(--text-secondary); margin-bottom:4px; display:block;">é—œéµå­—æœå°‹ (åç¨± / å­¸ç”Ÿ)</label>
                        <input type="text" id="overview-text-search" class="list-search" placeholder="è¼¸å…¥é—œéµå­—é€²è¡Œæœå°‹..." oninput="renderGlobalList()">
                    </div>
                    
                    <input type="text" id="student-search" class="list-search" placeholder="ğŸ” æœå°‹å­¸è™Ÿæˆ–å§“å..." onkeyup="window.filterStudentList()">

                    <div style="overflow-y:auto; max-height:600px; border:1px solid var(--border); border-radius:var(--radius-sm);">
                        <table id="main-table-display" class="data-table" style="margin:0; border:none;"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç•™è¨€ Modal -->
    <div id="comment-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="window.closeModal('comment-modal')">&times;</span>
            <h3 id="modal-title">ç•™è¨€æ¿</h3>
            <div id="comment-history" class="modal-body"></div>
            <div id="new-comment-area" style="margin-top: 15px; border-top: 1px solid var(--border); padding-top: 15px; background:var(--bg-input); padding:15px; border-radius:var(--radius-sm);">
                <textarea id="comment-input" rows="3" style="width:100%; margin-bottom:10px; border:1px solid var(--border); border-radius:var(--radius-sm); padding:10px;" placeholder="è¼¸å…¥ç•™è¨€..."></textarea>
                <button id="submit-comment-btn" class="btn btn-primary" style="width:100%;">é€å‡ºç•™è¨€</button>
            </div>
        </div>
    </div>

    <!-- åœ˜éšŠç·¨è¼¯/æ–°å¢ Modal -->
    <div id="team-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="window.closeModal('team-modal')">&times;</span>
            <h3 id="team-modal-title">ç®¡ç†åœ˜éšŠæ´»å‹•</h3>
            <div class="modal-scroll">
                <form id="team-form">
                    <input type="hidden" id="team-edit-id">
                    <div class="input-group">
                        <label>æ´»å‹•åç¨±</label>
                        <input type="text" id="team-name" required>
                    </div>
                    <div class="input-group">
                        <label>åŠ å…¥æ¨¡å¼</label>
                        <select id="team-join-mode">
                            <option value="open">å…è¨±åŠ å…¥ (å­¸ç”Ÿå¯è‡ªè¡ŒåŠ å…¥)</option>
                            <option value="restricted">åƒ…é™è¢«å‹•åŠ å…¥ (åƒ…æ•™å“¡å¯æ‹‰äºº)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>ç›®å‰ç‹€æ…‹</label>
                        <select id="team-status">
                            <option value="æœªå®Œæˆ">æœªå®Œæˆ</option>
                            <option value="å¯©æ ¸ä¸­">å¯©æ ¸ä¸­</option>
                            <option value="èªè­‰å¤±æ•—">èªè­‰å¤±æ•—</option>
                            <option value="å·²èªè­‰">å·²èªè­‰</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>æ´»å‹•èªªæ˜ (åƒ…é™æ–‡å­—)</label>
                        <textarea id="team-description" rows="4" placeholder="è«‹è¼¸å…¥æ´»å‹•èªªæ˜æˆ–è¦å‰‡..."></textarea>
                    </div>
                    
                    <div class="action-btn-group" style="margin-top:20px; border-top:1px solid var(--border); padding-top:20px;">
                        <button type="submit" class="btn btn-primary">å„²å­˜åœ˜éšŠè¨­å®š</button>
                        <button type="button" class="btn btn-danger hidden" id="delete-team-btn">åˆªé™¤æ­¤æ´»å‹•</button>
                    </div>
                </form>

                <hr style="margin:25px 0; border:0; border-top:1px dashed var(--border);">

                <h4>æˆå“¡ç®¡ç†</h4>
                <p style="font-size:0.9em; color:var(--text-secondary); margin-bottom:10px;">è¼¸å…¥å®Œæ•´å­¸è™Ÿä¸¦æŒ‰æ–°å¢æŒ‰éˆ•ã€‚</p>
                <div class="action-btn-group">
                    <input type="text" id="team-add-member-input" placeholder="è¼¸å…¥å­¸è™Ÿ" style="padding:8px;">
                    <button class="btn btn-info" onclick="window.addMemberToTeam()">æ–°å¢æˆå“¡</button>
                </div>
                <div id="team-members-list" style="margin-top:15px; max-height:250px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <!-- å­¸ç”ŸåŠ å…¥åœ˜éšŠ Modal -->
    <div id="team-join-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="window.closeModal('team-join-modal')">&times;</span>
            <h3>å¯åŠ å…¥çš„åœ˜éšŠæ´»å‹•</h3>
            <div class="modal-body">
                <div id="available-teams-list"></div>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡æ–°å¢ Modal (è¦å‰‡è¨­å®š) -->
    <div id="batch-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="window.closeModal('batch-modal')">&times;</span>
            <h3>æ‰¹æ¬¡æ–°å¢è¦å‰‡è¨­å®š</h3>
            <div class="modal-scroll">
                <div class="rule-help">
                    <strong>å¯ç”¨åƒæ•¸èªªæ˜ï¼š</strong><br>
                    <code>[number]</code> : é€£çºŒè™Ÿç¢¼ã€‚ä¾‹å¦‚ <code>[number]{num=2}</code> ç”¢ç”Ÿ 01, 02<br>
                    <code>[year]</code> : å¹´ä»½ã€‚<code>[year]{national=roc}</code> = æ°‘åœ‹å¹´<br>
                    <code>[date]</code> : æ—¥æœŸã€‚<code>[date]{yyyymmdd}</code> = 20260203<br>
                    <code>[time]</code> : æ™‚é–“ã€‚<code>[time]{format=hhmm}</code> = 1330<br>
                    <code>[rand]</code> : äº‚æ•¸ã€‚<code>[rand]{num=1}</code> = 0-9<br>
                    <code>[student_num]</code> : ç•¶å‰å­¸è™Ÿ
                </div>

                <div class="input-group">
                    <label>ç”Ÿæˆæ•¸é‡ (èµ·å§‹ ~ çµæŸ)</label>
                    <div class="batch-inputs-wrapper">
                        <input type="number" id="batch-start" value="0" placeholder="èµ·å§‹" min="0" oninput="window.updatePreview()">
                        <input type="number" id="batch-end" value="10" placeholder="çµæŸ" min="0" oninput="window.updatePreview()">
                    </div>
                </div>

                <hr style="margin:20px 0; border:0; border-top:1px dashed var(--border);">

                <div class="input-group">
                    <label>å­¸æ ¡é è¨­</label>
                    <input type="text" id="batch-school" value="æ°¸é–é«˜å·¥">
                </div>
                <div class="input-group">
                    <label>ç­ç´šé è¨­</label>
                    <input type="text" id="batch-class" value="è³‡è¨ŠäºŒ">
                </div>
                
                <div class="input-group">
                    <label>å­¸è™Ÿç”Ÿæˆè¦å‰‡</label>
                    <textarea id="batch-rule-account" rows="2" placeholder="ä¾‹å¦‚: [time][date]{yyyymmdd}" oninput="window.updatePreview()">[time][date]{yyyymmdd}</textarea>
                </div>

                <div class="input-group">
                    <label>Email è¦å‰‡</label>
                    <textarea id="batch-rule-email" rows="2" placeholder="ä¾‹å¦‚: [student_num]@school.edu.tw" oninput="window.updatePreview()">[student_num]@stu.yjvs.chc.edu.tw</textarea>
                </div>

                <h4 style="margin:15px 0 5px 0; font-size:0.9em; color:var(--text-secondary);">å³æ™‚é è¦½ (å‰3ç­†)</h4>
                <div class="preview-box" id="batch-preview">ç­‰å¾…è¼¸å…¥...</div>

                <div class="action-btn-group" style="margin-top:20px;">
                    <button class="btn btn-primary" onclick="window.prepareBatchReview()">ä¸‹ä¸€æ­¥ï¼šé è¦½ä¸¦ç”Ÿæˆ</button>
                    <button class="btn btn-secondary" onclick="window.closeModal('batch-modal')">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡æ–°å¢ Modal (å¯©æ ¸èˆ‡ç·¨è¼¯) -->
    <div id="batch-review-modal" class="modal">
        <div class="modal-content" style="max-width:800px;">
            <span class="close-modal" onclick="window.closeModal('batch-review-modal')">&times;</span>
            <h3>ç¢ºèªæ–°å¢è³‡æ–™ (Step 2/2)</h3>
            <p style="color:var(--text-secondary); margin-bottom:15px;">è«‹ç¢ºèªè³‡æ–™ã€‚æ‚¨å¯ä»¥ç›´æ¥ä¿®æ”¹è¡¨æ ¼å…§å®¹ã€‚</p>
            
            <div class="action-btn-group" style="background:var(--bg-input); padding:15px; border-radius:var(--radius-sm); margin-bottom:15px;">
                <div style="flex:1;"><label style="font-size:0.8em; color:var(--text-secondary); display:block; margin-bottom:4px;">å…¨æ ¡çµ±ä¸€å­¸æ ¡</label><input type="text" id="review-global-school" placeholder="è¼¸å…¥ä»¥æ›´æ–°å…¨éƒ¨..."></div>
                <div style="flex:1;"><label style="font-size:0.8em; color:var(--text-secondary); display:block; margin-bottom:4px;">å…¨ç­çµ±ä¸€ç­ç´š</label><input type="text" id="review-global-class" placeholder="è¼¸å…¥ä»¥æ›´æ–°å…¨éƒ¨..."></div>
            </div>

            <div style="border:1px solid var(--border); border-radius:var(--radius-sm); max-height:400px; overflow-y:auto;">
                <table class="batch-table">
                    <thead>
                        <tr>
                            <th style="width: 25%;">å­¸æ ¡</th><th style="width: 15%;">ç­ç´š</th><th style="width: 20%;">å­¸è™Ÿ</th><th style="width: 15%;">å§“å</th><th style="width: 25%;">Email</th>
                        </tr>
                    </thead>
                    <tbody id="review-table-body"></tbody>
                </table>
            </div>

            <div class="action-btn-group" style="margin-top:20px; justify-content: flex-end;">
                <button class="btn btn-danger" onclick="window.closeModal('batch-review-modal')">æ”¾æ£„</button>
                <button class="btn btn-success" onclick="window.finalizeBatchAdd()">ç¢ºèªç”Ÿæˆè³‡æ–™</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // --- è¨­å®šå€ ---
        let GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzX2NDNurs4gE1LXQQfvEpo8_GnUv0qv9Fb5oUIK_c8BDkpcmyNBfeP-ofSZdk2S3MY/exec";

        const TEAMS_KEY = 'certSystem_teams';
        const STUDENTS_KEY = 'certSystem_students';
        
        let students = {}; 
        let teams = {};
        let currentMode = 'student'; 
        let editingStudentId = null;
        let editingTeamId = null;
        let viewingAccountId = null; 
        let viewingTaskId = null;
        let viewingIsTeam = false; 
        let nextTaskId = 100; 
        let pendingBatchList = []; 
        let isSyncing = false;

        // --- Google Sheet åŒæ­¥é‚è¼¯ ---

        async function fetchDataFromSheet() {
            if (!GOOGLE_SCRIPT_URL) {
                const localS = localStorage.getItem(STUDENTS_KEY);
                const localT = localStorage.getItem(TEAMS_KEY);
                if (localS && localT) {
                    students = JSON.parse(localS);
                    teams = JSON.parse(localT);
                    showToast('å·²è¼‰å…¥æœ¬åœ°é›¢ç·šè³‡æ–™ (æœªè¨­å®š Google Sheet)', 'info');
                } else {
                    students = {};
                    teams = {};
                    showToast('ç„¡è³‡æ–™åº«é€£ç·šï¼Œç³»çµ±ç‚ºé›¢ç·šæ¨¡å¼', 'warning');
                }
                return;
            }

            showLoading(true);
            try {
                const payload = { action: 'getData' };
                const body = new URLSearchParams();
                body.append('data', JSON.stringify(payload));

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: body
                });

                if (!response.ok) throw new Error('Network response was not ok');
                
                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error('è§£æ JSON å¤±æ•—: ' + text.substring(0,100));
                }
                
                if (data.result === 'success') {
                    students = data.students || {};
                    teams = data.teams || {};
                    localStorage.setItem(STUDENTS_KEY, JSON.stringify(students));
                    localStorage.setItem(TEAMS_KEY, JSON.stringify(teams));
                    document.getElementById('sync-status').innerHTML = 'âœ” å·²é€£ç·šä¸¦åŒæ­¥';
                    document.getElementById('sync-status').style.color = 'var(--success)';
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Sheet Sync Error:', error);
                showToast('è³‡æ–™åº«åŒæ­¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å¿«å–è³‡æ–™', 'error');
                document.getElementById('sync-status').innerHTML = 'âŒ åŒæ­¥å¤±æ•— (é›¢ç·šæ¨¡å¼)';
                document.getElementById('sync-status').style.color = 'var(--danger)';
                
                const localS = localStorage.getItem(STUDENTS_KEY);
                const localT = localStorage.getItem(TEAMS_KEY);
                if (localS && localT) {
                    students = JSON.parse(localS);
                    teams = JSON.parse(localT);
                }
            } finally {
                showLoading(false);
            }
        }

        async function pushDataToSheet() {
            if (!GOOGLE_SCRIPT_URL) {
                localStorage.setItem(STUDENTS_KEY, JSON.stringify(students));
                localStorage.setItem(TEAMS_KEY, JSON.stringify(teams));
                return; 
            }

            if (isSyncing) return; 
            isSyncing = true;
            
            localStorage.setItem(STUDENTS_KEY, JSON.stringify(students));
            localStorage.setItem(TEAMS_KEY, JSON.stringify(teams));

            try {
                const payload = { 
                    action: 'saveData',
                    students: students,
                    teams: teams
                };
                
                const body = new URLSearchParams();
                body.append('data', JSON.stringify(payload));

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: body
                });

                const text = await response.text();
                const data = JSON.parse(text || '{}');
                
                if (data.result !== 'success') {
                    throw new Error(data.error || 'Unknown Error');
                }
            } catch (error) {
                console.error('Save Error:', error);
                throw error; 
            } finally {
                setTimeout(() => { isSyncing = false; }, 1000);
            }
        }

        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = show ? 'flex' : 'none';
            if (show) {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.style.opacity = '1', 10);
            } else {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.style.display = 'none', 500);
            }
        }

        function generateTeamId() { return 'TEAM_' + new Date().getTime(); }

        function maskEmail(e, accountId) { 
            if (!e) return 'ç„¡';
            if (accountId) {
                const parts = e.split('@');
                const idStr = String(accountId).toLowerCase(); 
                if (parts.length === 2 && parts[0].toLowerCase() === idStr) return e;
            }
            const parts = e.split('@');
            if (parts.length === 2) {
                const local = parts[0];
                if (local.length > 2) return local[0] + '**@' + parts[1];
                if (local.length > 0) return local[0] + '*@' + parts[1];
            }
            return e;
        }

        function maskName(n) { 
            if (!n || n.length < 1) return '';
            if (n.length <= 2) return n[0] + '*';
            return n[0] + '*'.repeat(n.length - 2) + n[n.length - 1];
        }

        window.showToast = function(msg, type='info') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerText = msg;
            container.appendChild(el);
            setTimeout(() => { el.style.transform = 'translateY(20px)'; el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
        }

        window.showConfirmDialog = function(msg) {
            return new Promise(resolve => {
                const d = document.getElementById('confirm-container');
                d.style.display = 'flex';
                d.innerHTML = `<div class="confirm-box"><p style="margin-bottom:20px; color:var(--text-main); font-size:1.1em;">${msg}</p><div class="action-btn-group" style="justify-content:center;"><button class="btn btn-primary" style="width:80px;">ç¢ºå®š</button> <button class="btn btn-secondary" style="width:80px;">å–æ¶ˆ</button></div></div>`;
                d.querySelector('.btn-primary').onclick = () => { d.style.display='none'; resolve(true); };
                d.querySelector('.btn-secondary').onclick = () => { d.style.display='none'; resolve(false); };
            });
        }

        window.closeModal = function(id) { document.getElementById(id).style.display = 'none'; }

        window.hideAll = function() {
            document.querySelectorAll('#login-container, #admin-login-container, #result-container, #admin-container').forEach(e => e.classList.add('hidden'));
        }

        window.showStudentLogin = function() {
            currentMode = 'student';
            window.hideAll();
            const el = document.getElementById('login-container');
            el.classList.remove('hidden');
            document.getElementById('login-error').classList.add('hidden');
            el.classList.remove('animate-panel-enter');
            void el.offsetWidth; // trigger reflow
            el.classList.add('animate-panel-enter');
        }

        window.showAdminLogin = function() {
            window.hideAll();
            const el = document.getElementById('admin-login-container');
            el.classList.remove('hidden');
            document.getElementById('admin-password').value = '';
            el.classList.remove('animate-panel-enter');
            void el.offsetWidth;
            el.classList.add('animate-panel-enter');
        }
        
        window.switchAdminTab = function(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const activeBtn = document.querySelector(`.tab-btn[onclick="window.switchAdminTab('${tabName}')"]`);
            if(activeBtn) activeBtn.classList.add('active');
            
            ['tab-student-action', 'tab-team-action', 'tab-overview-action', 'tab-batch-action'].forEach(id => document.getElementById(id).classList.add('hidden'));
            
            const targetPanel = document.getElementById(`tab-${tabName}-action`);
            targetPanel.classList.remove('hidden');
            targetPanel.classList.remove('animate-panel-enter');
            void targetPanel.offsetWidth; 
            targetPanel.classList.add('animate-panel-enter');

            const listTitle = document.getElementById('list-title');
            const studentSearch = document.getElementById('student-search');
            const overviewSearch = document.getElementById('overview-search-container');
            const listContainer = document.querySelector('.list-container');

            listContainer.classList.remove('animate-panel-enter');
            void listContainer.offsetWidth;
            listContainer.classList.add('animate-panel-enter');

            if(overviewSearch) overviewSearch.classList.add('hidden');
            if(studentSearch) studentSearch.classList.remove('hidden');

            if (tabName === 'student') {
                listTitle.innerText = 'å­¸ç”Ÿåˆ—è¡¨';
                renderStudentList();
            } else if (tabName === 'team') {
                listTitle.innerText = 'åœ˜éšŠæ´»å‹•åˆ—è¡¨';
                renderTeamList();
            } else if (tabName === 'overview') {
                listTitle.innerText = 'å…¨åŸŸèªè­‰åˆ—è¡¨';
                if(overviewSearch) overviewSearch.classList.remove('hidden');
                if(studentSearch) studentSearch.classList.add('hidden');
                renderGlobalList();
            } else if (tabName === 'batch') {
                listTitle.innerText = 'ç³»çµ±èªªæ˜';
                document.getElementById('main-table-display').innerHTML = '<div style="padding:40px; text-align:center; color:var(--text-secondary);">è«‹åœ¨å·¦å´é¢æ¿æ“ä½œ</div>';
            }
        }

        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const s = students[document.getElementById('account').value.trim()];
            if (s && s.school === document.getElementById('school').value.trim() && s.class === document.getElementById('class').value.trim()) {
                displayStudentResult(s);
            } else {
                const err = document.getElementById('login-error');
                err.textContent = "è³‡æ–™éŒ¯èª¤";
                err.classList.remove('hidden');
            }
        });

        document.getElementById('admin-login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const pwd = document.getElementById('admin-password').value;
            
            showLoading(true);
            try {
                const payload = { action: 'loginCheck', password: pwd };
                const body = new URLSearchParams();
                body.append('data', JSON.stringify(payload));

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: body
                });

                if (!response.ok) throw new Error('Network error');
                
                const result = await response.json();

                if (result.result === 'success') {
                    currentMode = 'admin';
                    window.hideAll();
                    const el = document.getElementById('admin-container');
                    el.classList.remove('hidden');
                    window.switchAdminTab('student');
                    showWelcomePanel();
                } else {
                    const err = document.getElementById('admin-login-error');
                    err.textContent = "å¯†ç¢¼éŒ¯èª¤";
                    err.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Admin Login Error:', error);
                showToast('é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯', 'error');
            } finally {
                showLoading(false);
            }
        });

        function displayStudentResult(s) {
            currentMode = 'student';
            viewingAccountId = s.account; 
            window.hideAll();
            const el = document.getElementById('result-container');
            el.classList.remove('hidden');
            el.classList.remove('animate-panel-enter');
            void el.offsetWidth;
            el.classList.add('animate-panel-enter');

            document.getElementById('result-account').textContent = s.account;
            document.getElementById('result-name').textContent = maskName(s.name); 
            document.getElementById('result-school').textContent = s.school;
            document.getElementById('result-class').textContent = s.class;
            document.getElementById('result-email').textContent = maskEmail(s.email, s.account);

            const tbody = document.querySelector('#tasks-table-student tbody');
            tbody.innerHTML = '';
            
            if (!s.tasks) s.tasks = [];
            s.tasks.forEach(t => {
                const tr = tbody.insertRow();
                tr.innerHTML = `
                    <td><div style="font-weight:500;">${t.name}</div></td>
                    <td><span class="badge status-${t.status}">${t.status}</span></td>
                    <td style="text-align:right;"></td>`;
                const td = tr.cells[2];
                const visibleCount = (t.comments || []).filter(c => !c.isRecalled).length;
                let btns = `<span class="action-btn-group">
                    <button class="btn btn-secondary btn-small" onclick="window.openCommentModal('${s.account}', ${t.id}, 'student', false)">ç•™è¨€ (${visibleCount})</button>
                `;
                if (t.status === 'æœªå®Œæˆ' || t.status === 'èªè­‰å¤±æ•—') {
                    btns += ` <button class="btn btn-primary btn-small" onclick="window.reqCert('${s.account}', ${t.id}, false)">è«‹æ±‚èªè­‰</button>`;
                } else if (t.status === 'å·²èªè­‰') {
                    btns += ` <button class="btn btn-warning btn-small" onclick="window.reqReCert('${s.account}', ${t.id}, false)">é‡æ–°å¯©æ ¸</button>`;
                }
                btns += `</span>`;
                td.innerHTML = btns;
            });

            const myTeams = (s.joinedTeams || []).filter(tid => teams[tid]);
            if (myTeams.length > 0) {
                const sepRow = tbody.insertRow();
                sepRow.innerHTML = `<td colspan="3" style="background:var(--bg-body); text-align:center; color:var(--text-secondary); font-weight:600; padding:12px;">- åœ˜éšŠæ´»å‹• -</td>`;
                myTeams.forEach(tid => {
                    const t = teams[tid];
                    const tr = tbody.insertRow();
                    tr.innerHTML = `
                        <td><div style="font-weight:500;"><span class="team-badge">åœ˜éšŠ</span>${t.name}</div></td>
                        <td><span class="badge status-${t.status}">${t.status}</span></td>
                        <td style="text-align:right;"></td>`;
                    const td = tr.cells[2];
                    const visibleCount = (t.comments || []).filter(c => !c.isRecalled).length;
                    let btns = `<span class="action-btn-group">
                        <button class="btn btn-secondary btn-small" onclick="window.openCommentModal('${tid}', 0, 'student', true)">ç•™è¨€ (${visibleCount})</button>
                    `;
                    if (t.status === 'æœªå®Œæˆ' || t.status === 'èªè­‰å¤±æ•—') {
                        btns += ` <button class="btn btn-primary btn-small" onclick="window.reqCert('${tid}', 0, true)">è«‹æ±‚åœ˜éšŠèªè­‰</button>`;
                    } else if (t.status === 'å·²èªè­‰') {
                        btns += ` <button class="btn btn-warning btn-small" onclick="window.reqReCert('${tid}', 0, true)">é‡æ–°å¯©æ ¸</button>`;
                    }
                    btns += `</span>`;
                    td.innerHTML = btns;
                });
            }
        }

        // ç™»å‡ºé‚è¼¯ with Typewriter Animation (OPUS only)
        window.logout = async function() {
            const isOpus = document.body.getAttribute('data-theme') === 'opus';
            
            // éš±è—ç•¶å‰è¦–åœ–
            document.getElementById('result-container').classList.add('hidden');
            document.getElementById('admin-container').classList.add('hidden');

            const overlay = document.getElementById('logout-overlay');
            overlay.style.display = 'flex';
            
            // å…ˆé¡¯ç¤ºé»‘è‰²èƒŒæ™¯
            overlay.style.opacity = '0';
            setTimeout(() => overlay.style.opacity = '1', 10);

            if (isOpus) {
                // OPUS æ¨¡å¼ï¼šæ‰“å­—æ©Ÿç‰¹æ•ˆ
                const textEl = document.querySelector('.typewriter-text');
                const cursor = document.createElement('span');
                cursor.className = 'cursor';
                textEl.innerHTML = '';
                textEl.appendChild(cursor);

                const str = "See you next time";
                let i = 0;
                
                function typeChar() {
                    if (i < str.length) {
                        const span = document.createElement('span');
                        span.textContent = str.charAt(i);
                        span.style.opacity = 0;
                        textEl.insertBefore(span, cursor);
                        setTimeout(() => span.style.opacity = 1, 20); 
                        i++;
                        setTimeout(typeChar, 100);
                    } else {
                        // å…¨éƒ¨æ‰“å®Œï¼Œå»¶é²å¾Œå›åˆ°ç™»å…¥
                        setTimeout(() => {
                            overlay.style.opacity = 0;
                            setTimeout(() => {
                                overlay.style.display = 'none';
                                overlay.style.opacity = 1;
                                window.showToast('å·²ç™»å‡º'); 
                                window.showStudentLogin();
                            }, 500);
                        }, 2000);
                    }
                }
                setTimeout(typeChar, 500); // ç¨å¾®å»¶é²é–‹å§‹æ‰“å­—
            } else {
                // æ™®é€šæ¨¡å¼ï¼šç°¡å–®çš„æ·¡å‡º
                setTimeout(() => {
                    overlay.style.opacity = 0;
                    setTimeout(() => {
                        overlay.style.display = 'none';
                        overlay.style.opacity = 1;
                        window.showToast('å·²ç™»å‡º'); 
                        window.showStudentLogin();
                    }, 500);
                }, 1000);
            }
        }
        
        window.adminLogout = () => { window.logout(); }

        window.reqCert = async function(id, tid, isTeam) {
            if (await window.showConfirmDialog('ç¢ºå®šç”³è«‹èªè­‰ï¼Ÿ')) {
                showLoading(true);
                try {
                    if (isTeam) { teams[id].status = 'å¯©æ ¸ä¸­'; } 
                    else { students[id].tasks.find(t=>t.id==tid).status = 'å¯©æ ¸ä¸­'; }
                    await pushDataToSheet();
                    displayStudentResult(students[viewingAccountId]);
                    window.showToast('å·²ç”³è«‹', 'success');
                } catch (error) {
                    console.error(error);
                    window.showToast('é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                } finally {
                    showLoading(false);
                }
            }
        }
        window.reqReCert = async function(id, tid, isTeam) {
            if (await window.showConfirmDialog('ç¢ºå®šé‡æ–°æäº¤ï¼Ÿ')) {
                showLoading(true);
                try {
                    if (isTeam) { teams[id].status = 'å¯©æ ¸ä¸­'; } 
                    else { students[id].tasks.find(t=>t.id==tid).status = 'å¯©æ ¸ä¸­'; }
                    await pushDataToSheet();
                    displayStudentResult(students[viewingAccountId]);
                    window.showToast('å·²é‡æ–°æäº¤', 'success');
                } catch (error) {
                    console.error(error);
                    window.showToast('é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                } finally {
                    showLoading(false);
                }
            }
        }

        function renderStudentList() {
            const table = document.getElementById('main-table-display');
            const term = document.getElementById('student-search').value.toLowerCase();
            table.innerHTML = `<thead><tr><th>å­¸è™Ÿ</th><th>å§“å</th> <th style="text-align:right; width:140px;">æ“ä½œ</th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            Object.keys(students).sort().forEach(k => {
                const s = students[k];
                if (k.toLowerCase().includes(term) || s.name.toLowerCase().includes(term)) {
                    const tr = tbody.insertRow();
                    tr.insertCell().textContent = k;
                    tr.insertCell().textContent = s.name;
                    tr.insertCell().innerHTML = `
                        <div class="action-btn-group" style="justify-content:flex-end;">
                            <button class="btn btn-primary btn-small" onclick="window.editStudent('${k}')">ç·¨è¼¯</button>
                            <button class="btn btn-danger btn-small" onclick="window.delStudent('${k}')">åˆªé™¤</button>
                        </div>`;
                }
            });
        }
        window.filterStudentList = renderStudentList;

        window.showWelcomePanel = async function() {
            if (editingStudentId && await window.showConfirmDialog('æœªå„²å­˜ï¼Œç¢ºå®šè¿”å›ï¼Ÿ')) {
                editingStudentId = null;
                document.getElementById('admin-welcome-panel').classList.remove('hidden');
                document.getElementById('student-form-panel').classList.add('hidden');
            } else if (!editingStudentId) {
                document.getElementById('admin-welcome-panel').classList.remove('hidden');
                document.getElementById('student-form-panel').classList.add('hidden');
            }
            
            const el = document.getElementById('admin-welcome-panel');
            el.classList.remove('animate-panel-enter');
            void el.offsetWidth;
            el.classList.add('animate-panel-enter');
        }

        window.showStudentForm = function(mode) {
            document.getElementById('admin-welcome-panel').classList.add('hidden');
            document.getElementById('student-form-panel').classList.remove('hidden');
            
            if (mode === 'new') window.switchToNewStudentMode(false);

            const el = document.getElementById('student-form-panel');
            el.classList.remove('animate-panel-enter');
            void el.offsetWidth;
            el.classList.add('animate-panel-enter');
        }

        window.switchToNewStudentMode = async function(confirmIt = true) {
            if (confirmIt && editingStudentId) { if (!await window.showConfirmDialog('ç¢ºå®šåˆ‡æ›ï¼Ÿ')) return; }
            editingStudentId = null;
            const form = document.getElementById('student-form');
            if (form) form.reset();
            document.getElementById('admin-school').value = 'æ°¸é–é«˜å·¥';
            document.getElementById('admin-class').value = 'è³‡è¨ŠäºŒ';
            const tbody = document.querySelector('#tasks-table-admin tbody');
            if (tbody) tbody.innerHTML = '';
            
            document.getElementById('submit-student-btn').innerText = 'æ–°å¢å­¸ç”Ÿ';
            document.getElementById('submit-student-btn').className = 'btn btn-primary';
            document.getElementById('switch-to-new-student-btn').classList.add('hidden');
            document.getElementById('admin-account').readOnly = false;
        }

        window.editStudent = function(id) {
            const studentTab = document.getElementById('tab-student-action');
            if (studentTab.classList.contains('hidden')) {
                window.switchAdminTab('student');
            }

            const s = students[id];
            editingStudentId = id;
            document.getElementById('admin-welcome-panel').classList.add('hidden');
            document.getElementById('student-form-panel').classList.remove('hidden');
            document.getElementById('submit-student-btn').innerText = 'å„²å­˜è®Šæ›´';
            document.getElementById('submit-student-btn').className = 'btn btn-success';
            document.getElementById('switch-to-new-student-btn').classList.remove('hidden');
            const form = document.getElementById('student-form');
            document.getElementById('admin-account').value = s.account;
            document.getElementById('admin-account').readOnly = true;
            document.getElementById('admin-name').value = s.name;
            document.getElementById('admin-school').value = s.school;
            document.getElementById('admin-class').value = s.class;
            document.getElementById('admin-email').value = s.email;
            const tbody = document.querySelector('#tasks-table-admin tbody');
            tbody.innerHTML = '';
            (s.tasks || []).forEach(t => addTaskRow(t));
            
            const el = document.getElementById('student-form-panel');
            el.classList.remove('animate-panel-enter');
            void el.offsetWidth;
            el.classList.add('animate-panel-enter');
        }

        window.addTaskRow = function(task=null) {
            const isNew = !task;
            const tid = isNew ? nextTaskId++ : task.id;
            const tbody = document.querySelector('#tasks-table-admin tbody');
            const tr = tbody.insertRow();
            tr.setAttribute('data-id', tid);
            const name = task ? task.name : '';
            const status = task ? task.status : 'æœªå®Œæˆ';
            const comments = task ? task.comments : [];
            const commentCount = comments.filter(c=>!c.isRecalled).length;

            tr.innerHTML = `
                <td><input type="text" class="task-name" value="${name}" placeholder="é …ç›®åç¨±" required style="border:none; background:transparent; font-weight:500; width:85%;"></td>
                <td>
                    <select class="task-status" style="width:90%; border:1px solid var(--border); border-radius:4px; font-size:0.8em;">
                        <option value="æœªå®Œæˆ" ${status=='æœªå®Œæˆ'?'selected':''}>æœªå®Œæˆ</option>
                        <option value="å¯©æ ¸ä¸­" ${status=='å¯©æ ¸ä¸­'?'selected':''}>å¯©æ ¸ä¸­</option>
                        <option value="èªè­‰å¤±æ•—" ${status=='èªè­‰å¤±æ•—'?'selected':''}>å¤±æ•—</option>
                        <option value="å·²èªè­‰" ${status=='å·²èªè­‰'?'selected':''}>å·²èªè­‰</option>
                    </select>
                </td>
                <td style="text-align:center;">
                    <button class="btn btn-secondary btn-small" onclick="window.openCommentModal('${editingStudentId||''}', ${tid}, 'admin', false)" ${!editingStudentId?'disabled':''}>ğŸ’¬${commentCount}</button>
                </td>
                <td style="text-align:center; width:10px;"><button class="btn btn-danger btn-small" style="padding:2px 6px; font-size:12px;" onclick="this.closest('tr').remove()">âœ•</button></td>
            `;
        }

        document.getElementById('student-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            showLoading(true);
            try {
                const id = document.getElementById('admin-account').value.trim();
                if (!editingStudentId && students[id]) { 
                    window.showToast('å­¸è™Ÿé‡è¤‡', 'error'); 
                    return; 
                }
                
                const tasks = [];
                const rows = document.querySelectorAll('#tasks-table-admin tbody tr');
                rows.forEach(r => {
                    const tid = parseInt(r.getAttribute('data-id'));
                    const existingStudent = students[editingStudentId || id];
                    const existingTask = existingStudent ? (existingStudent.tasks || []).find(x=>x.id==tid) : null;
                    tasks.push({
                        id: tid, name: r.querySelector('.task-name').value.trim(),
                        status: r.querySelector('.task-status').value,
                        comments: existingTask ? existingTask.comments : []
                    });
                });
                
                students[id] = {
                    account: id, name: document.getElementById('admin-name').value.trim(),
                    school: document.getElementById('admin-school').value.trim(),
                    class: document.getElementById('admin-class').value.trim(),
                    email: document.getElementById('admin-email').value.trim(), tasks: tasks,
                    joinedTeams: (students[id] ? students[id].joinedTeams : [])
                };
                
                await pushDataToSheet();
                renderStudentList();
                window.showToast('å„²å­˜æˆåŠŸ', 'success');
                if (!editingStudentId) window.switchToNewStudentMode(false); 
            } catch (error) {
                console.error("Save Error:", error);
                window.showToast('ç™¼ç”ŸéŒ¯èª¤ï¼Œç„¡æ³•å„²å­˜', 'error');
            } finally {
                showLoading(false);
            }
        });

        window.delStudent = async function(id) {
            if (!await window.showConfirmDialog('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
            showLoading(true);
            try {
                (students[id].joinedTeams || []).forEach(tid => {
                    if(teams[tid]) { teams[tid].members = teams[tid].members.filter(m => m !== id); }
                });
                delete students[id];
                await pushDataToSheet();
                renderStudentList();
            } catch (error) {
                console.error("Delete Error:", error);
                window.showToast('åˆªé™¤å¤±æ•—', 'error');
            } finally {
                showLoading(false);
            }
        }

        // --- åœ˜éšŠç›¸é—œé‚è¼¯ ---
        function renderTeamList() {
            const table = document.getElementById('main-table-display');
            const keys = Object.keys(teams);
            table.innerHTML = `<thead><tr><th>æ´»å‹•åç¨±</th><th>æ¨¡å¼</th><th>æˆå“¡</th><th style="text-align:right; width:160px;">æ“ä½œ</th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            
            if (keys.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px; color:var(--text-secondary);">ç›®å‰å°šç„¡åœ˜éšŠæ´»å‹•</td></tr>';
                return;
            }
            keys.forEach(tid => {
                const t = teams[tid];
                const tr = tbody.insertRow();
                tr.innerHTML = `
                    <td>
                        <div style="font-weight:600; margin-bottom:4px;">${t.name}</div>
                        <div style="font-size:0.8em; color:var(--text-secondary);">ç‹€æ…‹: ${t.status}</div>
                    </td>
                    <td>${t.joinMode==='open'?'<span class="badge" style="background:var(--success-light); color:var(--success);">é–‹æ”¾</span>':'<span class="badge" style="background:var(--warning-light); color:var(--warning);">é™åˆ¶</span>'}</td>
                    <td style="text-align:center; font-weight:600;">${(t.members||[]).length}</td>
                    <td style="text-align:right;">
                        <div class="action-btn-group" style="justify-content:flex-end;">
                            <button class="btn btn-info btn-small" onclick="window.openCommentModal('${tid}', 0, 'admin', true)">ğŸ’¬ ${(t.comments||[]).filter(c=>!c.isRecalled).length}</button>
                            <button class="btn btn-primary btn-small" onclick="window.openTeamModal('${tid}')">ç®¡ç†</button>
                            <button class="btn btn-danger btn-small" onclick="window.delTeam('${tid}')">åˆªé™¤</button>
                        </div>
                    </td>`;
            });
        }

        window.openTeamModal = function(teamId) {
            editingTeamId = teamId || null;
            const modal = document.getElementById('team-modal');
            modal.style.display = 'flex';
            const form = document.getElementById('team-form');
            const delBtn = document.getElementById('delete-team-btn');
            
            if (teamId) {
                const t = teams[teamId];
                document.getElementById('team-modal-title').innerText = `ç®¡ç†åœ˜éšŠ: ${t.name}`;
                document.getElementById('team-name').value = t.name;
                document.getElementById('team-edit-id').value = t.id;
                document.getElementById('team-join-mode').value = t.joinMode;
                document.getElementById('team-status').value = t.status;
                document.getElementById('team-description').value = t.description ? t.description : "";
                delBtn.classList.remove('hidden');
                delBtn.onclick = async () => { await window.delTeam(teamId); window.closeModal('team-modal'); };
            } else {
                document.getElementById('team-modal-title').innerText = 'æ–°å¢åœ˜éšŠæ´»å‹•';
                document.getElementById('team-edit-id').value = '';
                document.getElementById('team-name').value = '';
                document.getElementById('team-join-mode').value = 'open';
                document.getElementById('team-status').value = 'æœªå®Œæˆ';
                document.getElementById('team-description').value = "";
                delBtn.classList.add('hidden');
            }
            renderTeamMembers();
        }

        document.getElementById('team-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            showLoading(true);
            try {
                const id = document.getElementById('team-edit-id').value || generateTeamId();
                const isNew = !teams[id];
                
                teams[id] = {
                    id: id, name: document.getElementById('team-name').value.trim(),
                    status: document.getElementById('team-status').value, 
                    joinMode: document.getElementById('team-join-mode').value,
                    description: document.getElementById('team-description').value.trim(),
                    members:isNew ? [] : teams[id].members, 
                    comments: isNew ? [] : teams[id].comments
                };
                await pushDataToSheet();
                renderTeamList();
                window.closeModal('team-modal');
                window.showToast('å·²å„²å­˜', 'success');
            } catch (error) {
                console.error("Team Save Error:", error);
                window.showToast('å„²å­˜å¤±æ•—', 'error');
            } finally {
                showLoading(false);
            }
        });

        window.delTeam = async function(id) {
            if (await window.showConfirmDialog('ç¢ºå®šåˆªé™¤æ­¤æ´»å‹•ï¼Ÿæˆå“¡å°‡æœƒè¢«ç§»é™¤ã€‚')) {
                showLoading(true);
                try {
                    const t = teams[id];
                    t.members.forEach(mId => {
                        if (students[mId]) { students[mId].joinedTeams = students[mId].joinedTeams.filter(tid => tid !== id); }
                    });
                    delete teams[id];
                    await pushDataToSheet();
                    renderTeamList();
                } catch (error) {
                    console.error("Delete Team Error:", error);
                    window.showToast('åˆªé™¤å¤±æ•—', 'error');
                } finally {
                    showLoading(false);
                }
            }
        }

        function renderTeamMembers() {
            const list = document.getElementById('team-members-list');
            list.innerHTML = '';
            if (!editingTeamId) return;
            const t = teams[editingTeamId];
            (t.members || []).forEach(mid => {
                const s = students[mid];
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.style.alignItems = 'center';
                div.style.padding = '6px 0';
                div.style.borderBottom = '1px solid var(--border)';
                div.innerHTML = `<span style="font-size:0.9em;">${mid} <span style="color:#94a3b8; font-size:0.8em;">(${s ? s.name : 'æœªçŸ¥ç”¨æˆ¶'})</span></span><button class="btn btn-danger btn-small" style="padding:2px 8px; font-size:12px;" onclick="window.removeMember('${mid}')">ç§»é™¤</button>`;
                list.appendChild(div);
            });
        }

        window.addMemberToTeam = async function() {
            if (!editingTeamId) return;
            const input = document.getElementById('team-add-member-input');
            const mid = input.value.trim();
            const t = teams[editingTeamId];
            
            if (!students[mid]) { window.showToast('å­¸è™Ÿä¸å­˜åœ¨', 'error'); return; }
            if ((t.members || []).includes(mid)) { window.showToast('å·²åœ¨åœ˜éšŠä¸­', 'error'); return; }
            
            showLoading(true);
            try {
                if(!t.members) t.members = [];
                t.members.push(mid);
                if (!students[mid].joinedTeams) students[mid].joinedTeams = [];
                students[mid].joinedTeams.push(editingTeamId);
                await pushDataToSheet();
                input.value = '';
                renderTeamMembers();
                renderTeamList();
                window.showToast('æˆå“¡å·²åŠ å…¥', 'success');
            } catch (error) {
                console.error("Add Member Error:", error);
                window.showToast('æ–°å¢å¤±æ•—', 'error');
            } finally {
                showLoading(false);
            }
        }

        window.removeMember = async function(mid) {
            if (!confirm(`ç¢ºå®šç§»é™¤ ${mid}?`)) return;
            showLoading(true);
            try {
                const t = teams[editingTeamId];
                t.members = t.members.filter(id => id !== mid);
                if (students[mid]) { students[mid].joinedTeams = students[mid].joinedTeams.filter(tid => tid !== editingTeamId); }
                await pushDataToSheet();
                renderTeamMembers();
                renderTeamList();
            } catch (error) {
                console.error("Remove Member Error:", error);
                window.showToast('ç§»é™¤å¤±æ•—', 'error');
            } finally {
                showLoading(false);
            }
        }

        window.openTeamJoinModal = function() {
            const modal = document.getElementById('team-join-modal');
            const list = document.getElementById('available-teams-list');
            list.innerHTML = '';
            
            const myId = viewingAccountId;
            const myTeams = students[myId] ? (students[myId].joinedTeams || []) : [];
            const available = Object.keys(teams).filter(tid => {
                const t = teams[tid];
                return t.joinMode === 'open' && !myTeams.includes(tid);
            });

            if (available.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:var(--text-secondary); padding:40px;">ç›®å‰æ²’æœ‰å¯åŠ å…¥çš„é–‹æ”¾åœ˜éšŠæ´»å‹•ã€‚</p>';
            } else {
                available.forEach(tid => {
                    const t = teams[tid];
                    const div = document.createElement('div');
                    div.className = 'team-list-item';
                    div.innerHTML = `
                        <div class="team-info">
                            <h4 style="font-size:1em;">${t.name}</h4>
                            <p>æˆå“¡: ${(t.members||[]).length} äºº | ç‹€æ…‹: ${t.status}</p>
                        </div>
                        <button class="btn btn-info" onclick="window.joinTeam('${tid}')">åŠ å…¥</button>`;
                    list.appendChild(div);
                });
            }
            modal.style.display = 'flex';
        }

        window.joinTeam = async function(tid) {
            const t = teams[tid];
            const sid = viewingAccountId;
            if (!students[sid]) { window.showToast('ç”¨æˆ¶è³‡æ–™éŒ¯èª¤', 'error'); return; }
            
            showLoading(true);
            try {
                if(!t.members) t.members = [];
                t.members.push(sid);
                if (!students[sid].joinedTeams) students[sid].joinedTeams = [];
                students[sid].joinedTeams.push(tid);
                
                await pushDataToSheet();
                window.showToast('æˆåŠŸåŠ å…¥åœ˜éšŠ', 'success');
                window.closeModal('team-join-modal');
                displayStudentResult(students[sid]);
            } catch(error) {
                console.error("Join Error:", error);
                window.showToast('åŠ å…¥å¤±æ•—', 'error');
            } finally {
                showLoading(false);
            }
        }

        function renderGlobalList() {
            const table = document.getElementById('main-table-display');
            const textSearch = document.getElementById('overview-text-search').value.toLowerCase();
            const typeFilter = document.getElementById('overview-type-filter').value; 
            const statusFilter = document.getElementById('overview-status-filter').value; 
            
            let listData = [];
            let displayCount = 0, displayCertified = 0, displayFailed = 0;

            Object.keys(students).forEach(acct => {
                const s = students[acct];
                (s.tasks || []).forEach(t => {
                    if (typeFilter === 'team') return; 
                    if (statusFilter === 'todo' && t.status === 'å·²èªè­‰') return;
                    if (statusFilter === 'certified' && t.status !== 'å·²èªè­‰') return;
                    if (statusFilter === 'failed' && t.status !== 'èªè­‰å¤±æ•—') return;

                    if (textSearch) {
                        const taskName = t.name.toLowerCase();
                        const studentName = s.name.toLowerCase();
                        if (!taskName.includes(textSearch) && !studentName.includes(textSearch)) return;
                    }

                    displayCount++;
                    if(t.status === 'å·²èªè­‰') displayCertified++;
                    if(t.status === 'æœªå®Œæˆ' || t.status === 'èªè­‰å¤±æ•—' || t.status === 'å¯©æ ¸ä¸­') displayFailed++;

                    listData.push({
                        type: 'personal', name: t.name, status: t.status,
                        targetName: s.name, targetId: acct, taskId: t.id,
                        commentCount: (t.comments||[]).filter(c=>!c.isRecalled).length
                    });
                });
            });

            Object.keys(teams).forEach(tid => {
                const t = teams[tid];
                if (typeFilter === 'personal') return; 
                if (statusFilter === 'todo' && t.status === 'å·²èªè­‰') return;
                if (statusFilter === 'certified' && t.status !== 'å·²èªè­‰') return;
                if (statusFilter === 'failed' && t.status !== 'èªè­‰å¤±æ•—') return;

                if (textSearch) {
                    const teamName = t.name.toLowerCase();
                    if (!teamName.includes(textSearch)) return;
                }

                displayCount++;
                if(t.status === 'å·²èªè­‰') displayCertified++;
                if(t.status === 'æœªå®Œæˆ' || t.status === 'èªè­‰å¤±æ•—' || t.status === 'å¯©æ ¸ä¸­') displayFailed++;

                listData.push({
                    type: 'team', name: t.name, status: t.status,
                    targetName: `åœ˜éšŠ (${(t.members||[]).length}äºº)`, targetId: tid, taskId: 0,
                    commentCount: (t.comments||[]).filter(c=>!c.isRecalled).length
                });
            });

            document.getElementById('filtered-count').textContent = displayCount;
            document.getElementById('filtered-certified').textContent = displayCertified;
            document.getElementById('filtered-failed').textContent = displayFailed;

            table.innerHTML = `<thead><tr><th>é¡å‹</th><th>é …ç›®åç¨±</th><th>å°è±¡</th><th>ç‹€æ…‹</th><th style="text-align:right;">æ“ä½œ</th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            
            if (listData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px; color:var(--text-secondary);">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„é …ç›®</td></tr>`;
                return;
            }

            listData.forEach(item => {
                const tr = tbody.insertRow();
                const typeBadge = item.type === 'personal' 
                    ? `<span class="type-badge-group type-personal">å€‹äºº</span>` 
                    : `<span class="type-badge-group type-team">åœ˜éšŠ</span>`;
                const statusBadge = `<span class="badge status-${item.status}">${item.status}</span>`;
                
                let actionBtns = '';
                if (item.type === 'personal') {
                    actionBtns = `
                        <div class="action-btn-group" style="justify-content:flex-end;">
                            <button class="btn btn-secondary btn-small" onclick="window.openCommentModal('${item.targetId}', ${item.taskId}, 'admin', false)" title="ç•™è¨€">ğŸ’¬${item.commentCount}</button>
                            <button class="btn btn-primary btn-small" onclick="window.editStudent('${item.targetId}')" title="ç·¨è¼¯å­¸ç”Ÿ">ç·¨è¼¯</button>
                        </div>`;
                } else {
                    actionBtns = `
                        <div class="action-btn-group" style="justify-content:flex-end;">
                            <button class="btn btn-secondary btn-small" onclick="window.openCommentModal('${item.targetId}', 0, 'admin', true)" title="ç•™è¨€">ğŸ’¬${item.commentCount}</button>
                            <button class="btn btn-primary btn-small" onclick="window.openTeamModal('${item.targetId}')" title="ç®¡ç†åœ˜éšŠ">ç®¡ç†</button>
                        </div>`;
                }

                tr.innerHTML = `
                    <td style="width: 80px;">${typeBadge}</td>
                    <td><div style="font-weight:500;">${item.name}</div></td>
                    <td style="color:var(--text-secondary); font-size:0.9em;">${item.targetName}</td>
                    <td>${statusBadge}</td>
                    <td style="text-align:right;">${actionBtns}</td>`;
            });
        }

        function simulateProgressBar(duration) {
            return new Promise(resolve => {
                const barFill = document.getElementById('comment-history');
                const originalContent = barFill.innerHTML;
                
                barFill.innerHTML = `
                    <div class="progress-container">
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" id="anim-fill" style="width:0%"></div>
                        </div>
                        <div class="progress-text" id="anim-text">DECRYPTING DATA...</div>
                    </div>
                `;

                const fill = document.getElementById('anim-fill');
                const txt = document.getElementById('anim-text');
                const steps = ['CONNECTING', 'FETCHING', 'DECRYPTING', 'DONE'];
                let width = 0;
                let stepIndex = 0;

                const interval = setInterval(() => {
                    width += 2; 
                    fill.style.width = width + '%';
                    
                    if (width > (stepIndex + 1) * 25) {
                        stepIndex++;
                        if(stepIndex < steps.length) txt.innerText = steps[stepIndex];
                    }

                    if (width >= 100) {
                        clearInterval(interval);
                        resolve();
                    }
                }, duration / 50);
            });
        }

        window.openCommentModal = async function(itemId, taskId, mode, isTeam) {
            viewingAccountId = itemId; viewingTaskId = taskId; currentMode = mode; viewingIsTeam = isTeam;
            let comments = []; let taskName = '';
            
            if (isTeam) { const t = teams[itemId]; taskName = t.name; comments = t.comments || []; } 
            else { const s = students[itemId]; const task = (s.tasks||[]).find(x=>x.id==taskId); if(!task) return; taskName = task.name; comments = task.comments || []; }

            document.getElementById('modal-title').innerText = `ç•™è¨€æ¿: ${taskName}`;
            const modal = document.getElementById('comment-modal');
            modal.style.display = 'flex';
            
            await simulateProgressBar(1000); 

            renderCommentHistory(comments, mode, isTeam);
            const submitBtn = document.getElementById('submit-comment-btn');
            const inputArea = document.getElementById('comment-input');
            inputArea.value = '';
            
            submitBtn.onclick = async function() {
                const txt = document.getElementById('comment-input').value.trim();
                if(!txt) return;
                showLoading(true);
                try {
                    const newComment = { senderIdForName: mode === 'admin' ? 'teacher' : viewingAccountId, content: txt, timestamp: new Date().toLocaleString('zh-TW'), isRecalled: false };
                    if (isTeam) { 
                        if(!teams[itemId].comments) teams[itemId].comments = [];
                        teams[itemId].comments.push(newComment); 
                    } else { 
                        const taskList = students[itemId].tasks || [];
                        const task = taskList.find(x=>x.id==taskId);
                        if(!task.comments) task.comments = [];
                        task.comments.push(newComment); 
                    }
                    await pushDataToSheet(); 
                    inputArea.value = '';
                    renderCommentHistory(isTeam ? (teams[itemId].comments||[]) : (students[itemId].tasks.find(x=>x.id==taskId).comments||[]), mode, isTeam); 
                    if(currentMode !== 'admin') displayStudentResult(students[viewingAccountId]); 
                    else {
                        const activeTab = document.querySelector('button.tab-btn.active').innerText;
                        if(activeTab.includes('èªè­‰ç¸½è¦½')) renderGlobalList();
                        else if(activeTab.includes('å­¸ç”Ÿè³‡æ–™')) renderStudentList();
                        else renderTeamList();
                    }
                    window.showToast('ç•™è¨€å·²é€å‡º', 'success');
                } catch(e) {
                    window.showToast('é€å‡ºå¤±æ•—', 'error');
                } finally {
                    showLoading(false);
                }
            };
        }

        function renderCommentHistory(comments, viewMode, isTeam) {
            const container = document.getElementById('comment-history');
            container.innerHTML = '';
            comments.forEach((c, index) => {
                const div = document.createElement('div');
                let classType = c.senderIdForName === 'teacher' ? 'comment-teacher' : 'comment-student';
                if (c.isRecalled) classType += ' comment-recalled';
                div.className = `comment ${classType}`;
                let senderName = c.senderIdForName === 'teacher' ? 'æ•™å¸«' : c.senderIdForName;
                if (c.senderIdForName !== 'teacher' && students[c.senderIdForName]) senderName = students[c.senderIdForName].name;
                let contentHTML = c.isRecalled ? `<span style="font-style:italic">æ­¤ç•™è¨€å·²è¢«æ’¤å›</span>` : c.content;
                let actionButtons = '';
                if (!c.isRecalled) {
                    const isMyComment = (viewMode === 'student' && c.senderIdForName === viewingAccountId) || (viewMode === 'admin' && c.senderIdForName === 'teacher');
                    if (isMyComment) actionButtons += `<button class="btn btn-secondary btn-small" style="margin-top:8px; background:rgba(255,255,255,0.8);" onclick="window.handleCommentAction(${index}, 'recall', ${isTeam})">æ’¤å›</button>`;
                }
                div.innerHTML = `<div class="comment-header"><span>${senderName}</span><span style="font-weight:400; font-size:0.8em; color:var(--text-secondary);">${c.timestamp}</span></div><div>${contentHTML}</div><div class="comment-actions">${actionButtons}</div>`;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }

        window.handleCommentAction = async function(index, action, isTeam) {
            if (action === 'recall' && !await window.showConfirmDialog('ç¢ºå®šè¦æ’¤å›é€™å‰‡ç•™è¨€å—ï¼Ÿ')) return;
            showLoading(true);
            try {
                let comments; let saveFn;
                if (isTeam) { comments = teams[viewingAccountId].comments || []; saveFn = pushDataToSheet; } 
                else { const t = students[viewingAccountId].tasks.find(x=>x.id==viewingTaskId); comments = t.comments || []; saveFn = pushDataToSheet; }
                const c = comments[index];
                if (action === 'recall') c.isRecalled = true;
                await saveFn();
                renderCommentHistory(comments, currentMode, isTeam);
                const activeTab = document.querySelector('button.tab-btn.active').innerText;
                if(activeTab.includes('èªè­‰ç¸½è¦½')) renderGlobalList();
                else if(activeTab.includes('å­¸ç”Ÿè³‡æ–™')) renderStudentList();
                else renderTeamList();
                
                window.showToast('ç•™è¨€å·²æ’¤å›', 'success');
            } catch (e) {
                window.showToast('æ“ä½œå¤±æ•—', 'error');
            } finally {
                showLoading(false);
            }
        }

        window.exportData = () => {
            const data = { students: students, teams: teams };
            const d = JSON.stringify(data, null, 2);
            const a = document.createElement('a');
            a.href = 'data:text/json;charset=utf-8,'+encodeURIComponent(d);
            a.download = 'system_backup.json';
            a.click();
        }

        // --- Qèªæ³•è¦å‰‡è§£æèˆ‡æ‰¹æ¬¡ç”Ÿæˆé‚è¼¯ ---
        function parseParams(paramString) {
            const params = {};
            if (!paramString) return params;
            let cleanStr = paramString.replace(/ï¼Œ/g, ',').replace(/ï¼›/g, ';').replace(/ï½›/g, '{').replace(/ï½/g, '}').replace(/^\{|\}$/g, '');
            try {
                const items = cleanStr.split(/[,;]/); 
                for(let item of items) {
                    let p = item.trim();
                    if (!p) continue;
                    if (p.includes('=')) {
                        const idx = p.indexOf('=');
                        const k = p.substring(0, idx).trim();
                        const v = p.substring(idx + 1).trim();
                        if (v.includes(',')) { params[k] = v.split(',').map(s => s.trim()); } else { params[k] = v; }
                    } else { params[p] = true; }
                }
            } catch(e) { console.error("Parse Error", e); }
            return params;
        }

        function parseRule(ruleStr, context) {
            try {
                let result = ruleStr;
                result = result.replace(/\$([^\$]+)\$/g, (match, constant) => constant);
                result = result.replace(/\[([^\[\{]+)\](?:\{([^\}]*)\})?/g, (match, ruleName, args) => {
                    const params = parseParams(args);
                    let output = "";
                    const now = new Date();
                    switch(ruleName.trim()) {
                        case 'number': let num = context.baseNum; if(params.start) num = (context.ruleIndex - 1) + parseInt(params.start); output = params.num ? num.toString().padStart(parseInt(params.num), '0') : num.toString(); break;
                        case 'year': let y = now.getFullYear(); output = params.national === 'roc' ? (y - 1911).toString() : y.toString(); break;
                        case 'date': const yyyy = now.getFullYear(); const yy = (yyyy % 100).toString().padStart(2,'0'); const mm = (now.getMonth()+1).toString().padStart(2,'0'); const dd = now.getDate().toString().padStart(2,'0'); if (params.yyyymmdd) output = yyyy + mm + dd; else if (params.ddmmyyyy) output = dd + mm + yyyy; else if (params.yymmdd) output = yy + mm + dd; else if (params.ddmm) output = dd + mm; else if (params.mmdd) output = mm + dd; else output = yyyy + '/' + mm + '/' + dd; break;
                        case 'time': const hh = now.getHours().toString().padStart(2,'0'); const min = now.getMinutes().toString().padStart(2,'0'); const ss = now.getSeconds().toString().padStart(2,'0'); output = (params.format === 'hhmm') ? (hh + min) : (hh + min + ss); break;
                        case 'rand': let digits = parseInt(params.num) || 4; let max = Math.pow(10, digits) - 1; let r = Math.floor(Math.random() * (max + 1)); output = r.toString().padStart(digits, '0'); break;
                        case 'student_num': output = context.studentNum || ""; break;
                        default: output = match;
                    }
                    return output;
                });
                return result;
            } catch(e) { console.error("Rule Error", e); return "ERROR"; }
        }

        window.updatePreview = function() {
            const startInput = parseInt(document.getElementById('batch-start').value);
            const rule = document.getElementById('batch-rule-account').value;
            const previewEl = document.getElementById('batch-preview');
            if (!rule.trim()) { previewEl.textContent = 'è«‹è¼¸å…¥å­¸è™Ÿè¦å‰‡'; return; }
            if (isNaN(startInput) || startInput < 0) { previewEl.textContent = 'èµ·å§‹éŒ¯èª¤ (éœ€å¤§æ–¼0)'; return; }
            let html = '';
            for (let i = 0; i < 3; i++) {
                const ctx = { ruleIndex: i+1, baseNum: startInput + i, studentNum: '' };
                const res = parseRule(rule, ctx);
                html += `${startInput + i}: ${res}\n`;
            }
            previewEl.textContent = html;
        }

        window.prepareBatchReview = function() {
            const startInput = parseInt(document.getElementById('batch-start').value);
            const endInput = parseInt(document.getElementById('batch-end').value);
            const cls = document.getElementById('batch-class').value;
            const school = (document.getElementById('batch-school')?.value) || 'æ°¸é–é«˜å·¥';
            const ruleAccount = document.getElementById('batch-rule-account').value;
            let ruleEmail = document.getElementById('batch-rule-email').value.trim();

            if (isNaN(startInput) || isNaN(endInput) || startInput < 0 || endInput < 0 || startInput > endInput) { window.showToast('è™Ÿç¢¼ç¯„åœéŒ¯èª¤ (éœ€å¤§æ–¼ç­‰æ–¼0)', 'error'); return; }
            if (!ruleAccount) { window.showToast('è«‹è¼¸å…¥å­¸è™Ÿè¦å‰‡', 'error'); return; }
            let notList = [];
            const numParamsMatch = ruleAccount.match(/\[number\](?:\{([^\}]*)\})?/);
            if (numParamsMatch) {
                const params = parseParams(numParamsMatch[1]);
                if (params.not) notList = Array.isArray(params.not) ? params.not.map(n => parseInt(n)) : [parseInt(params.not)];
            }
            pendingBatchList = [];
            for (let i = startInput; i <= endInput; i++) {
                if (notList.includes(i)) continue;
                const ctx = { ruleIndex: i, baseNum: i };
                const finalAccount = parseRule(ruleAccount, ctx);
                if (finalAccount === "ERROR") continue;
                if (students[finalAccount]) continue;
                let finalEmail = '';
                if (ruleEmail) {
                    const emailCtx = { ruleIndex: i, baseNum: i, studentNum: finalAccount };
                    finalEmail = parseRule(ruleEmail, emailCtx);
                }
                pendingBatchList.push({ school: school, class: cls, account: finalAccount, name: 'å¾…è¼¸å…¥', email: finalEmail });
            }
            window.closeModal('batch-modal');
            window.openBatchReviewModal();
        }

        window.openBatchReviewModal = function() {
            const modal = document.getElementById('batch-review-modal');
            modal.style.display = 'flex';
            document.getElementById('review-global-school').value = '';
            document.getElementById('review-global-class').value = '';
            renderBatchReviewTable();
        }

        function renderBatchReviewTable() {
            const tbody = document.getElementById('review-table-body');
            tbody.innerHTML = '';
            if (pendingBatchList.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:40px;">æ²’æœ‰è³‡æ–™</td></tr>'; return; }
            pendingBatchList.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><input type="text" data-idx="${index}" data-field="school" value="${item.school}"></td><td><input type="text" data-idx="${index}" data-field="class" value="${item.class}"></td><td><input type="text" data-idx="${index}" data-field="account" value="${item.account}"></td><td><input type="text" data-idx="${index}" data-field="name" value="${item.name}"></td><td><input type="text" data-idx="${index}" data-field="email" value="${item.email || ''}"></td>`;
                tbody.appendChild(tr);
            });
        }

        function setupGlobalListeners() {
            const updateSchool = document.getElementById('review-global-school');
            const updateClass = document.getElementById('review-global-class');
            const handleUpdate = (field, inputEl) => { const val = inputEl.value; if (!val) return; const inputs = document.querySelectorAll(`input[data-field="${field}"]`); inputs.forEach(inp => inp.value = val); };
            updateSchool.addEventListener('input', () => handleUpdate('school', updateSchool));
            updateClass.addEventListener('input', () => handleUpdate('class', updateClass));
        }
        setupGlobalListeners();

        document.getElementById('review-table-body').addEventListener('input', function(e) {
            if(e.target.tagName === 'INPUT') { const idx = e.target.dataset.idx; const field = e.target.dataset.field; pendingBatchList[idx][field] = e.target.value; }
        });

        window.finalizeBatchAdd = async function() {
            if (pendingBatchList.length === 0) { window.showToast('æ²’æœ‰è³‡æ–™å¯å„²å­˜', 'error'); return; }
            if (!await window.showConfirmDialog(`ç¢ºå®šæ–°å¢ ${pendingBatchList.length} ç­†å­¸ç”Ÿè³‡æ–™ï¼Ÿ`)) return;
            
            showLoading(true);
            try {
                let count = 0; let errors = [];
                for (const s of pendingBatchList) { if (students[s.account]) { errors.push(`å­¸è™Ÿ ${s.account} å·²å­˜åœ¨`); } }
                if (errors.length > 0) { window.showToast(`ç™¼ç”ŸéŒ¯èª¤:\n${errors.join('\n')}`, 'error'); return; }
                for (const s of pendingBatchList) {
                    students[s.account] = { account: s.account, name: s.name, school: s.school, class: s.class, email: s.email, tasks: [], joinedTeams: [] }; count++;
                }
                await pushDataToSheet(); 
                
                window.switchAdminTab('student'); 
                showToast(`æˆåŠŸæ–°å¢ ${count} ä½å­¸ç”Ÿ`, 'success'); 
                window.closeModal('batch-review-modal');
            } catch (error) {
                console.error("Batch Add Error:", error);
                window.showToast('æ‰¹æ¬¡æ–°å¢å¤±æ•—', 'error');
            } finally {
                showLoading(false);
            }
        }
        window.openBatchModal = function() { document.getElementById('batch-modal').style.display = 'flex'; window.updatePreview(); }

        window.onload = async function() {
            await fetchDataFromSheet();
            initTheme();
        }

        // --- ä¸»é¡Œåˆ‡æ›ç³»çµ± ---
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'default';
            setTheme(savedTheme);
            document.getElementById('theme-toggle-btn').addEventListener('click', cycleTheme);
        }

        function setTheme(themeName) {
            const body = document.body;
            const themes = ['default', 'dark', 'opus'];
            const validTheme = themes.includes(themeName) ? themeName : 'default';

            body.removeAttribute('data-theme');

            if (validTheme !== 'default') {
                body.setAttribute('data-theme', validTheme);
            }

            localStorage.setItem('theme', validTheme);
        }

        function cycleTheme() {
            const themes = ['default', 'dark', 'opus'];
            const currentTheme = localStorage.getItem('theme') || 'default';
            const currentIndex = themes.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % themes.length;
            setTheme(themes[nextIndex]);
            
            const themeNames = { 'default': 'æ·ºè‰²ä¸»é¡Œ', 'dark': 'æ·±è‰²ä¸»é¡Œ', 'opus': 'OPUS é¢¨æ ¼' };
            showToast(`å·²åˆ‡æ›è‡³: ${themeNames[themes[nextIndex]]}`, 'info');
        }

    </script>
</body>
</html>
